{"config":{"indexing":"full","lang":["en"],"min_search_length":3,"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"\u6d59\u6c5f\u5927\u5b6622\u5e74\u79cb\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c \u672c \u4ed3\u5e93 \u662f\u6d59\u6c5f\u5927\u5b6622\u5e74\u79cb \u64cd\u4f5c\u7cfb\u7edf \u8bfe\u7a0b\u7684\u6559\u5b66\u4ed3\u5e93\uff0c\u5305\u542b\u5728\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4e0a\u6240\u6709\u7684\u5b9e\u9a8c\u6587\u6863\u548c\u516c\u5f00\u4ee3\u7801\u3002\u4ed3\u5e93\u76ee\u5f55\u7ed3\u6784\uff1a 1 2 3 4 \u251c\u2500\u2500 README.md \u251c\u2500\u2500 docs/ # \u5b9e\u9a8c\u6587\u6863 \u251c\u2500\u2500 mkdocs.yml \u2514\u2500\u2500 src/ # \u516c\u5f00\u4ee3\u7801 \u5b9e\u9a8c\u6587\u6863\u5df2\u7ecf\u90e8\u7f72\u5728\u4e86 gitee pages \u4e0a\uff0c\u65b9\u4fbf\u5927\u5bb6\u9605\u8bfb\u3002 \u672c\u5730\u6e32\u67d3\u6587\u6863 \u6587\u6863\u91c7\u7528\u4e86 mkdocs-material \u5de5\u5177\u6784\u5efa\u548c\u90e8\u7f72\u3002\u5982\u679c\u60f3\u5728\u672c\u5730\u6e32\u67d3\uff1a 1 2 3 4 5 6 7 $ pip3 install mkdocs-material # \u5b89\u88c5 mkdocs-material $ git clone https://gitee.com/zjusec/os22fall-stu # clone \u672c repo $ mkdocs serve # \u672c\u5730\u6e32\u67d3 INFO - Building documentation... INFO - Cleaning site directory ... INFO - [ 11 :00:57 ] Serving on http://127.0.0.1:8000/os22fall-stu/ \u81f4\u8c22 \u611f\u8c22\u4ee5\u4e0b\u5404\u4f4d\u8001\u5e08\u548c\u52a9\u6559\u7684\u8f9b\u52e4\u4ed8\u51fa\uff01 \u7533\u6587\u535a \u3001 \u5468\u4e9a\u91d1 \u3001\u5f90\u91d1\u7131\u3001\u5468\u4fa0\u3001\u7ba1\u7ae0\u8f89\u3001\u5f20\u6587\u9f99\u3001\u5218\u5f3a\u3001\u5b59\u5bb6\u680b\u3001\u5468\u5929\u6631\u3001\u5e84\u963f\u5f97\u3001\u738b\u7428\u3001\u6c88\u97ec\u7acb\u3001\u738b\u661f\u5b87\u3001\u6731\u749f\u68ee\u3001\u8c22\u6d35\u3001 \u6f58\u5b50\u66f0 \u3001\u6731\u82e5\u51e1\u3001\u5b63\u9ad8\u5f3a\u3001\u90ed\u82e5\u5bb9\u3001\u675c\u4e91\u6f47","title":"\u6d59\u6c5f\u5927\u5b6622\u5e74\u79cb\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c"},{"location":"#22","text":"\u672c \u4ed3\u5e93 \u662f\u6d59\u6c5f\u5927\u5b6622\u5e74\u79cb \u64cd\u4f5c\u7cfb\u7edf \u8bfe\u7a0b\u7684\u6559\u5b66\u4ed3\u5e93\uff0c\u5305\u542b\u5728\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u4e0a\u6240\u6709\u7684\u5b9e\u9a8c\u6587\u6863\u548c\u516c\u5f00\u4ee3\u7801\u3002\u4ed3\u5e93\u76ee\u5f55\u7ed3\u6784\uff1a 1 2 3 4 \u251c\u2500\u2500 README.md \u251c\u2500\u2500 docs/ # \u5b9e\u9a8c\u6587\u6863 \u251c\u2500\u2500 mkdocs.yml \u2514\u2500\u2500 src/ # \u516c\u5f00\u4ee3\u7801 \u5b9e\u9a8c\u6587\u6863\u5df2\u7ecf\u90e8\u7f72\u5728\u4e86 gitee pages \u4e0a\uff0c\u65b9\u4fbf\u5927\u5bb6\u9605\u8bfb\u3002","title":"\u6d59\u6c5f\u5927\u5b6622\u5e74\u79cb\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c"},{"location":"#_1","text":"\u6587\u6863\u91c7\u7528\u4e86 mkdocs-material \u5de5\u5177\u6784\u5efa\u548c\u90e8\u7f72\u3002\u5982\u679c\u60f3\u5728\u672c\u5730\u6e32\u67d3\uff1a 1 2 3 4 5 6 7 $ pip3 install mkdocs-material # \u5b89\u88c5 mkdocs-material $ git clone https://gitee.com/zjusec/os22fall-stu # clone \u672c repo $ mkdocs serve # \u672c\u5730\u6e32\u67d3 INFO - Building documentation... INFO - Cleaning site directory ... INFO - [ 11 :00:57 ] Serving on http://127.0.0.1:8000/os22fall-stu/","title":"\u672c\u5730\u6e32\u67d3\u6587\u6863"},{"location":"#_2","text":"\u611f\u8c22\u4ee5\u4e0b\u5404\u4f4d\u8001\u5e08\u548c\u52a9\u6559\u7684\u8f9b\u52e4\u4ed8\u51fa\uff01 \u7533\u6587\u535a \u3001 \u5468\u4e9a\u91d1 \u3001\u5f90\u91d1\u7131\u3001\u5468\u4fa0\u3001\u7ba1\u7ae0\u8f89\u3001\u5f20\u6587\u9f99\u3001\u5218\u5f3a\u3001\u5b59\u5bb6\u680b\u3001\u5468\u5929\u6631\u3001\u5e84\u963f\u5f97\u3001\u738b\u7428\u3001\u6c88\u97ec\u7acb\u3001\u738b\u661f\u5b87\u3001\u6731\u749f\u68ee\u3001\u8c22\u6d35\u3001 \u6f58\u5b50\u66f0 \u3001\u6731\u82e5\u51e1\u3001\u5b63\u9ad8\u5f3a\u3001\u90ed\u82e5\u5bb9\u3001\u675c\u4e91\u6f47","title":"\u81f4\u8c22"},{"location":"faq/","text":"\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54 Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25 1 Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25 \u8fd9\u79cd\u60c5\u51b5\u8bf7\u4f7f\u7528 wget \u7b49\u5de5\u5177\u5c06 Linux \u6e90\u7801\u4e0b\u8f7d\u81f3\u5bb9\u5668\u5185\u76ee\u5f55 \u800c\u975e\u5171\u4eab\u76ee\u5f55 \uff0c\u7136\u540e\u6267\u884c\u7f16\u8bd1\u3002 2 QEMU+GDB \u4f7f\u7528 si \u5355\u6307\u4ee4\u8c03\u8bd5\u9047\u5230\u6a21\u5f0f\u5207\u6362\u5931\u6548 \u5728\u9047\u5230\u8bf8\u5982 mret , sret \u7b49\u6307\u4ee4\u9020\u6210\u7684\u6a21\u5f0f\u5207\u6362\u65f6\uff0c si \u6307\u4ee4\u4f1a\u5931\u6548\uff0c\u53ef\u80fd\u8868\u73b0\u4e3a\u7a0b\u5e8f\u5f00\u59cb\u4e0d\u505c\u8dd1\uff0c\u5f71\u54cd\u5bf9\u7a0b\u5e8f\u8fd0\u884c\u884c\u4e3a\u7684\u5224\u65ad\u3002 \u4e00\u4e2a\u89e3\u51b3\u65b9\u6cd5\u662f\u5728\u7a0b\u5e8f \u9884\u671f\u8df3\u8f6c \u7684\u4f4d\u7f6e\u6253\u4e0a\u65ad\u70b9\uff0c\u65ad\u70b9\u4e0d\u4f1a\u53d7\u5230\u6a21\u5f0f\u5207\u6362\u7684\u5f71\u54cd\uff0c\u6bd4\u5982\uff1a 1 2 3 4 5 6 7 ( gdb ) i r sepc sepc 0x8000babe ( gdb ) b * 0x8000babe Breakpoint 1 at 0x8000babe ( gdb ) si # \u6216\u8005\u4f7f\u7528 c Breakpoint 1 , 0x000000008000babe in _never_gonna_give_you_up () ... \u8fd9\u6837\u5c31\u53ef\u4ee5\u770b\u5230\u65ad\u70b9\u88ab\u89e6\u53d1\uff0c\u53ef\u4ee5\u7ee7\u7eed\u8c03\u8bd5\u4e86\u3002","title":"\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54"},{"location":"faq/#_1","text":"Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25","title":"\u5e38\u89c1\u95ee\u9898\u53ca\u89e3\u7b54"},{"location":"faq/#1-linux","text":"\u8fd9\u79cd\u60c5\u51b5\u8bf7\u4f7f\u7528 wget \u7b49\u5de5\u5177\u5c06 Linux \u6e90\u7801\u4e0b\u8f7d\u81f3\u5bb9\u5668\u5185\u76ee\u5f55 \u800c\u975e\u5171\u4eab\u76ee\u5f55 \uff0c\u7136\u540e\u6267\u884c\u7f16\u8bd1\u3002","title":"1 Linux \u6e90\u7801\u653e\u5728\u5171\u4eab\u6587\u4ef6\u5939\u4e0b\u7f16\u8bd1\u5931\u8d25"},{"location":"faq/#2-qemugdb-si","text":"\u5728\u9047\u5230\u8bf8\u5982 mret , sret \u7b49\u6307\u4ee4\u9020\u6210\u7684\u6a21\u5f0f\u5207\u6362\u65f6\uff0c si \u6307\u4ee4\u4f1a\u5931\u6548\uff0c\u53ef\u80fd\u8868\u73b0\u4e3a\u7a0b\u5e8f\u5f00\u59cb\u4e0d\u505c\u8dd1\uff0c\u5f71\u54cd\u5bf9\u7a0b\u5e8f\u8fd0\u884c\u884c\u4e3a\u7684\u5224\u65ad\u3002 \u4e00\u4e2a\u89e3\u51b3\u65b9\u6cd5\u662f\u5728\u7a0b\u5e8f \u9884\u671f\u8df3\u8f6c \u7684\u4f4d\u7f6e\u6253\u4e0a\u65ad\u70b9\uff0c\u65ad\u70b9\u4e0d\u4f1a\u53d7\u5230\u6a21\u5f0f\u5207\u6362\u7684\u5f71\u54cd\uff0c\u6bd4\u5982\uff1a 1 2 3 4 5 6 7 ( gdb ) i r sepc sepc 0x8000babe ( gdb ) b * 0x8000babe Breakpoint 1 at 0x8000babe ( gdb ) si # \u6216\u8005\u4f7f\u7528 c Breakpoint 1 , 0x000000008000babe in _never_gonna_give_you_up () ... \u8fd9\u6837\u5c31\u53ef\u4ee5\u770b\u5230\u65ad\u70b9\u88ab\u89e6\u53d1\uff0c\u53ef\u4ee5\u7ee7\u7eed\u8c03\u8bd5\u4e86\u3002","title":"2 QEMU+GDB \u4f7f\u7528 si \u5355\u6307\u4ee4\u8c03\u8bd5\u9047\u5230\u6a21\u5f0f\u5207\u6362\u5931\u6548"},{"location":"lab0/","text":"Lab 0: GDB & QEMU \u8c03\u8bd5 64 \u4f4d RISC-V LINUX 1 \u5b9e\u9a8c\u76ee\u7684 \u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177, \u5b8c\u6210Linux\u5185\u6838\u4ee3\u7801\u7f16\u8bd1 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838 \u719f\u6089GDB\u548cQEMU\u8054\u5408\u8c03\u8bd5 2 \u5b9e\u9a8c\u73af\u5883 Ubuntu 22.04 Windows Subsystem for Linux 2 \u5176\u4ed6\u53ef\u884c\u7684\u5e73\u53f0\uff0c\u4f46\u6211\u4eec\u4e0d\u63d0\u4f9b\u6280\u672f\u652f\u6301 3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd 3.1 Linux \u4f7f\u7528\u57fa\u7840 \u5728 Linux \u73af\u5883\u4e0b\uff0c\u4eba\u4eec\u901a\u5e38\u4f7f\u7528\u547d\u4ee4\u884c\u63a5\u53e3\u6765\u5b8c\u6210\u4e0e\u8ba1\u7b97\u673a\u7684\u4ea4\u4e92\u3002\u7ec8\u7aef\uff08Terminal\uff09\u662f\u7528\u4e8e\u5904\u7406\u8be5\u8fc7\u7a0b\u7684\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u901a\u8fc7\u7ec8\u7aef\u4f60\u53ef\u4ee5\u8fd0\u884c\u5404\u79cd\u7a0b\u5e8f\u4ee5\u53ca\u5728\u81ea\u5df1\u7684\u8ba1\u7b97\u673a\u4e0a\u5904\u7406\u6587\u4ef6\u3002\u5728\u7c7b Unix \u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u7ec8\u7aef\u53ef\u4ee5\u4e3a\u4f60\u5b8c\u6210\u4e00\u5207\u4f60\u6240\u9700\u8981\u7684\u64cd\u4f5c\u3002\u4e0b\u9762\u6211\u4eec\u4ec5\u5bf9\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u7684\u4e00\u4e9b\u6982\u5ff5\u8fdb\u884c\u4ecb\u7ecd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u94fe\u63a5\u6765\u5bf9\u547d\u4ee4\u884c\u7684\u4f7f\u7528\u8fdb\u884c\u5b66\u4e60\uff1a The Missing Semester of Your CS Education >>Video<< GNU/Linux Command-Line Tools Summary Basics of UNIX 3.2 QEMU \u4f7f\u7528\u57fa\u7840 \u4ec0\u4e48\u662fQEMU QEMU \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6a21\u62df\u5668\uff0c\u53ef\u4ee5\u5728 x86 \u5e73\u53f0\u4e0a\u6267\u884c\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u7a0b\u5e8f\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u91c7\u7528 QEMU \u6765\u5b8c\u6210 RISC-V \u67b6\u6784\u7684\u7a0b\u5e8f\u7684\u6a21\u62df\u3002 \u5982\u4f55\u4f7f\u7528 QEMU\uff08\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd\uff09 \u4ee5\u4ee5\u4e0b\u547d\u4ee4\u4e3a\u4f8b\uff0c\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd QEMU \u7684\u53c2\u6570\u6240\u4ee3\u8868\u7684\u542b\u4e49 1 2 3 4 5 6 7 8 9 $ qemu-system-riscv64 \\ -nographic \\ -machine virt \\ -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 \\ -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default \\ -drive file = rootfs.img,format = raw,id = hd0 \\ -S -s -nographic : \u4e0d\u4f7f\u7528\u56fe\u5f62\u7a97\u53e3\uff0c\u4f7f\u7528\u547d\u4ee4\u884c -machine : \u6307\u5b9a\u8981 emulate \u7684\u673a\u5668\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -machine help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u673a\u5668\u9009\u9879 -kernel : \u6307\u5b9a\u5185\u6838 image -append cmdline : \u4f7f\u7528cmdline\u4f5c\u4e3a\u5185\u6838\u7684\u547d\u4ee4\u884c -device : \u6307\u5b9a\u8981\u6a21\u62df\u7684\u8bbe\u5907\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u8bbe\u5907\uff0c\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device <\u5177\u4f53\u7684\u8bbe\u5907>,help \u67e5\u770b\u67d0\u4e2a\u8bbe\u5907\u7684\u547d\u4ee4\u9009\u9879 -drive, file=<file_name> : \u4f7f\u7528 file_name \u4f5c\u4e3a\u6587\u4ef6\u7cfb\u7edf -S : \u542f\u52a8\u65f6\u6682\u505cCPU\u6267\u884c -s : -gdb tcp::1234 \u7684\u7b80\u5199 -bios default : \u4f7f\u7528\u9ed8\u8ba4\u7684 OpenSBI firmware \u4f5c\u4e3a bootloader \u66f4\u591a\u53c2\u6570\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc 3.3 GDB \u4f7f\u7528\u57fa\u7840 \u4ec0\u4e48\u662f GDB GNU \u8c03\u8bd5\u5668\uff08\u82f1\u8bed\uff1aGNU Debugger\uff0c\u7f29\u5199\uff1agdb\uff09\u662f\u4e00\u4e2a\u7531 GNU \u5f00\u6e90\u7ec4\u7ec7\u53d1\u5e03\u7684\u3001UNIX/LINUX \u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u3001\u57fa\u4e8e\u547d\u4ee4\u884c\u7684\u3001\u529f\u80fd\u5f3a\u5927\u7684\u7a0b\u5e8f\u8c03\u8bd5\u5de5\u5177\u3002\u501f\u52a9\u8c03\u8bd5\u5668\uff0c\u6211\u4eec\u80fd\u591f\u67e5\u770b\u53e6\u4e00\u4e2a\u7a0b\u5e8f\u5728\u6267\u884c\u65f6\u5b9e\u9645\u5728\u505a\u4ec0\u4e48\uff08\u6bd4\u5982\u8bbf\u95ee\u54ea\u4e9b\u5185\u5b58\u3001\u5bc4\u5b58\u5668\uff09\uff0c\u5728\u5176\u4ed6\u7a0b\u5e8f\u5d29\u6e83\u7684\u65f6\u5019\u53ef\u4ee5\u6bd4\u8f83\u5feb\u901f\u5730\u4e86\u89e3\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u7684\u539f\u56e0\u3002 \u88ab\u8c03\u8bd5\u7684\u7a0b\u5e8f\u53ef\u4ee5\u548c GDB \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u5e76\u7531 GDB \u63a7\u5236\uff08\u672c\u5730\u8c03\u8bd5 native debug\uff09\u3002\u4e5f\u53ef\u4ee5\u53ea\u548c gdb-server \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u7531\u8fde\u63a5\u7740 gdb-server \u7684 GDB \u8fdb\u884c\u63a7\u5236\uff08\u8fdc\u7a0b\u8c03\u8bd5 remote debug\uff09\u3002 GDB \u7684\u529f\u80fd\u5341\u5206\u5f3a\u5927\uff0c\u6211\u4eec\u7ecf\u5e38\u5728\u8c03\u8bd5\u4e2d\u7528\u5230\u7684\u6709: \u542f\u52a8\u7a0b\u5e8f\uff0c\u5e76\u6307\u5b9a\u53ef\u80fd\u5f71\u54cd\u5176\u884c\u4e3a\u7684\u6240\u6709\u5185\u5bb9 \u4f7f\u7a0b\u5e8f\u5728\u6307\u5b9a\u6761\u4ef6\u4e0b\u505c\u6b62 \u68c0\u67e5\u7a0b\u5e8f\u505c\u6b62\u65f6\u53d1\u751f\u4e86\u4ec0\u4e48 \u66f4\u6539\u7a0b\u5e8f\u4e2d\u7684\u5185\u5bb9\uff0c\u4ee5\u4fbf\u7ea0\u6b63\u4e00\u4e2abug\u7684\u5f71\u54cd GDB \u57fa\u672c\u547d\u4ee4\u4ecb\u7ecd (gdb) layout asm : \u663e\u793a\u6c47\u7f16\u4ee3\u7801 (gdb) start : \u5355\u6b65\u6267\u884c\uff0c\u8fd0\u884c\u7a0b\u5e8f\uff0c\u505c\u5728\u7b2c\u4e00\u6267\u884c\u8bed\u53e5 (gdb) continue : \u4ece\u65ad\u70b9\u540e\u7ee7\u7eed\u6267\u884c\uff0c\u7b80\u5199 c (gdb) next : \u5355\u6b65\u8c03\u8bd5\uff08\u9010\u8fc7\u7a0b\uff0c\u51fd\u6570\u76f4\u63a5\u6267\u884c\uff09\uff0c\u7b80\u5199 n (gdb) step instruction : \u6267\u884c\u5355\u6761\u6307\u4ee4\uff0c\u7b80\u5199 si (gdb) run : \u91cd\u65b0\u5f00\u59cb\u8fd0\u884c\u6587\u4ef6\uff08run-text\uff1a\u52a0\u8f7d\u6587\u672c\u6587\u4ef6\uff0crun-bin\uff1a\u52a0\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff09\uff0c\u7b80\u5199 r (gdb) backtrace \uff1a\u67e5\u770b\u51fd\u6570\u7684\u8c03\u7528\u7684\u6808\u5e27\u548c\u5c42\u7ea7\u5173\u7cfb\uff0c\u7b80\u5199 bt (gdb) break \u8bbe\u7f6e\u65ad\u70b9\uff0c\u7b80\u5199 b \u65ad\u5728 foo \u51fd\u6570\uff1a b foo \u65ad\u5728\u67d0\u5730\u5740: b * 0x80200000 (gdb) finish : \u7ed3\u675f\u5f53\u524d\u51fd\u6570\uff0c\u8fd4\u56de\u5230\u51fd\u6570\u8c03\u7528\u70b9 (gdb) frame : \u5207\u6362\u51fd\u6570\u7684\u6808\u5e27\uff0c\u7b80\u5199 f (gdb) print : \u6253\u5370\u503c\u53ca\u5730\u5740\uff0c\u7b80\u5199 p (gdb) info : \u67e5\u770b\u51fd\u6570\u5185\u90e8\u5c40\u90e8\u53d8\u91cf\u7684\u6570\u503c\uff0c\u7b80\u5199 i \u67e5\u770b\u5bc4\u5b58\u5668 ra \u7684\u503c: i r ra (gdb) display : \u8ffd\u8e2a\u67e5\u770b\u5177\u4f53\u53d8\u91cf\u503c (gdb) x/4x <addr> : \u4ee5 16 \u8fdb\u5236\u6253\u5370 <addr> \u5904\u5f00\u59cb\u7684 16 Bytes \u5185\u5bb9 \u66f4\u591a\u547d\u4ee4\u53ef\u4ee5\u53c2\u8003 100\u4e2agdb\u5c0f\u6280\u5de7 3.4 Linux \u5185\u6838\u7f16\u8bd1\u57fa\u7840 \u4ea4\u53c9\u7f16\u8bd1 \u4ea4\u53c9\u7f16\u8bd1\u6307\u7684\u662f\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728\u53e6\u4e00\u4e2a\u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\u3002\u4f8b\u5982\u5728 x86 \u673a\u5668\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V \u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u4ea4\u53c9\u7f16\u8bd1\u9700\u8981\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u652f\u6301\uff0c\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u6240\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5c31\u662f riscv-gnu-toolchain \u3002 \u5185\u6838\u914d\u7f6e \u5185\u6838\u914d\u7f6e\u662f\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u542f\u7528\u5185\u6838\u7684\u5404\u9879\u7279\u6027\uff0c\u5185\u6838\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a defconfig (\u5373default configuration) \u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e\u5404\u4e2a\u67b6\u6784\u76ee\u5f55\u7684 configs \u6587\u4ef6\u5939\u4e0b\uff0c\u4f8b\u5982\u5bf9\u4e8eRISC-V\u800c\u8a00\uff0c\u5176\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e3a arch/riscv/configs/defconfig \u3002\u4f7f\u7528 make ARCH=riscv defconfig \u547d\u4ee4\u53ef\u4ee5\u5728\u5185\u6838\u6839\u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2a\u540d\u4e3a .config \u7684\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u5185\u6838\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u5185\u6838\u5728\u7f16\u8bd1\u65f6\u4f1a\u6839\u636e .config \u8fdb\u884c\u7f16\u8bd1\u3002 \u914d\u7f6e\u4e4b\u95f4\u5b58\u5728\u76f8\u4e92\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u76f4\u63a5\u4fee\u6539defconfig\u6587\u4ef6\u6216\u8005 .config \u6709\u65f6\u5019\u5e76\u4e0d\u80fd\u8fbe\u5230\u60f3\u8981\u7684\u6548\u679c\uff0c\u6216\u662f\u7ed9\u8fdb\u4e00\u6b65\u5185\u6838\u914d\u7f6e\u5e26\u6765\u540c\u6b65\u95ee\u9898\u3002\u56e0\u6b64\u5982\u679c\u9700\u8981\u4fee\u6539\u914d\u7f6e\u4e00\u822c\u91c7\u7528 make ARCH=riscv menuconfig \u7684\u65b9\u5f0f\u5bf9\u5185\u6838\u8fdb\u884c\u914d\u7f6e\u3002 \u7f16\u8bd1\u5de5\u5177 make \u662f\u7528\u4e8e\u7a0b\u5e8f\u6784\u5efa\u7684\u91cd\u8981\u5de5\u5177\uff0c\u5b83\u7684\u884c\u4e3a\u7531\u5f53\u524d\u76ee\u5f55\u6216 make -C \u6307\u5b9a\u76ee\u5f55\u4e0b\u7684 Makefile \u6765\u51b3\u5b9a\u3002\u66f4\u591a\u6709\u5173 Makefile \u7684\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 Learn Makefiles With the tastiest examples \u3002\u4e0b\u9762\u7528\u672c\u6b21\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u7528\u5230\u7684\u7528\u4e8e\u7f16\u8bd1 Linux \u5185\u6838\u7684\u7f16\u8bd1\u547d\u4ee4\u4f5c\u4e3a\u793a\u4f8b\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ make help # \u67e5\u770bmake\u547d\u4ee4\u7684\u5404\u79cd\u53c2\u6570\u89e3\u91ca $ make <target-name> # \u7f16\u8bd1\u540d\u4e3a <target-name> \u7684\u76ee\u6807\u6587\u4ef6\u6216\u76ee\u6807\u4efb\u52a1 $ make defconfig # \u4f7f\u7528\u5f53\u524d\u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5728x86\u673a\u5668\u4e0a\u4f1a\u4f7f\u7528x86\u7684\u9ed8\u8ba4\u914d\u7f6e $ make clean # \u6e05\u9664\u6240\u6709\u7f16\u8bd1\u597d\u7684 object \u6587\u4ef6 $ make mrproper # \u5220\u9664\u6240\u6709\u7f16\u8bd1\u4ea7\u7269\u548c\u914d\u7f6e\u6587\u4ef6 $ make -j<thread-count> # \u4f7f\u7528 <thread-count> \u4e2a\u7269\u7406\u7ebf\u7a0b\u6765\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make -j4 # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j4 \u4e3a\u4f7f\u7528 4 \u7ebf\u7a0b\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make -j $( nproc ) # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j$(nproc) \u4e3a\u4ee5\u5168\u90e8\u673a\u5668\u786c\u4ef6\u7ebf\u7a0b\u6570\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make <var-name> = <var-value> # \u5728\u7f16\u8bd1\u8fc7\u7a0b\u4e2d\u5c06 <var-name> \u53d8\u91cf\u7684\u503c\u624b\u52a8\u8bbe\u7f6e\u4e3a <val-value> $ make ARCH = riscv defconfig # \u4f7f\u7528 RISC-V \u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- # \u7f16\u8bd1 RISC-V \u5e73\u53f0\u5185\u6838 \u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u4e3a make \u6307\u5b9a\u53d8\u91cf\u7684\u503c\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e2d\u7528\u5230\u7684\u5982\u4e0b\uff1a ARCH \u6307\u5b9a\u67b6\u6784\uff0c\u53ef\u9009\u7684\u503c\u5305\u62ec arch \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u5939\u540d\uff0c\u5982 x86\u3001arm\u3001arm64 \u7b49\uff0c\u4e0d\u540c\u4e8e arm \u548c arm64\uff0c32 \u4f4d\u548c 64 \u4f4d\u7684RISC-V\u5171\u7528 arch/riscv \u76ee\u5f55\uff0c\u901a\u8fc7\u4f7f\u7528\u4e0d\u540c\u7684 config \u53ef\u4ee5\u7f16\u8bd1 32 \u4f4d\u6216 64 \u4f4d\u7684\u5185\u6838\u3002 CROSS_COMPILE \u6307\u5b9a\u4f7f\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\uff0c\u4f8b\u5982\u6307\u5b9a CROSS_COMPILE=riscv64-linux-gnu- \uff0c\u5219\u7f16\u8bd1\u65f6\u4f1a\u91c7\u7528 riscv64-linux-gnu-gcc \u4f5c\u4e3a\u7f16\u8bd1\u5668\uff0c\u7f16\u8bd1\u5728 RISC-V 64 \u4f4d\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u3002 4 \u5b9e\u9a8c\u6b65\u9aa4 \u5728\u6267\u884c\u6bcf\u4e00\u6761\u547d\u4ee4\u524d\uff0c\u8bf7\u4f60\u5bf9\u5c06\u8981\u8fdb\u884c\u7684\u64cd\u4f5c\u8fdb\u884c\u601d\u8003\uff0c\u7ed9\u51fa\u7684\u547d\u4ee4\u4e0d\u9700\u8981\u5168\u90e8\u6267\u884c\uff0c\u5e76\u4e14\u4e0d\u662f\u6240\u6709\u7684\u547d\u4ee4\u90fd\u53ef\u4ee5\u65e0\u6761\u4ef6\u6267\u884c\uff0c\u8bf7\u4e0d\u8981\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u547d\u4ee4\u53bb\u6267\u884c\u3002 4.1 \u642d\u5efa\u5b9e\u9a8c\u73af\u5883\u73af\u5883 \u9996\u5148\u5b89\u88c5\u7f16\u8bd1\u5185\u6838\u6240\u9700\u8981\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u548c\u7528\u4e8e\u6784\u5efa\u7a0b\u5e8f\u7684\u8f6f\u4ef6\u5305 1 2 3 4 $ sudo apt install gcc-riscv64-linux-gnu $ sudo apt install autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev \\ gawk build-essential bison flex texinfo gperf libtool patchutils bc \\ zlib1g-dev libexpat-dev git \u63a5\u7740\u662f\u7528\u4e8e\u542f\u52a8 riscv64 \u5e73\u53f0\u4e0a\u7684\u5185\u6838\u7684\u6a21\u62df\u5668 qemu 1 $ sudo apt install qemu-system-misc \u6211\u4eec\u8fd8\u9700\u8981\u7528 gdb \u6765\u5bf9\u5728 qemu \u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u8fdb\u884c\u8c03\u8bd5 1 $ sudo apt install gdb-multiarch 4.2 \u83b7\u53d6 Linux \u6e90\u7801\u548c\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684\u6587\u4ef6\u7cfb\u7edf \u4ece https://www.kernel.org \u4e0b\u8f7d\u6700\u65b0\u7684 Linux \u6e90\u7801\u3002 \u622a\u81f3\u5199\u4f5c\u65f6\uff0c\u6700\u65b0\u7684 Linux \u5185\u6838\u7248\u672c\u662f 6.0rc5. \u5e76\u4e14\u4f7f\u7528 git \u5de5\u5177 clone \u672c\u4ed3\u5e93 \u3002\u5176\u4e2d\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002 \u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a Linux Kernel \u63d0\u4f9b\u4e86\u57fa\u7840\u7684\u6587\u4ef6\u670d\u52a1\uff0c\u5728\u542f\u52a8 Linux Kernel \u65f6\u662f\u5fc5\u8981\u7684\u3002 1 2 3 4 $ git clone https://gitee.com/zjusec/os22fall-stu $ cd os22fall-stu/src/lab0 $ ls rootfs.img # \u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf 4.3 \u7f16\u8bd1 linux \u5185\u6838 1 2 3 $ cd path/to/linux $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- defconfig # \u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- -j $( nproc ) # \u7f16\u8bd1 \u4f7f\u7528\u591a\u7ebf\u7a0b\u7f16\u8bd1\u4e00\u822c\u4f1a\u8017\u8d39\u5927\u91cf\u5185\u5b58\uff0c\u5982\u679c -j \u9009\u9879\u5bfc\u81f4\u5185\u5b58\u8017\u5c3d (out of memory)\uff0c\u8bf7\u5c1d\u8bd5\u8c03\u4f4e\u7ebf\u7a0b\u6570\uff0c\u6bd4\u5982 -j4 , -j8 \u7b49\u3002 4.4 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838 1 2 3 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = path/to/rootfs.img,format = raw,id = hd0 \u9000\u51fa QEMU \u7684\u65b9\u6cd5\u4e3a\uff1a\u4f7f\u7528 Ctrl+A\uff0c \u677e\u5f00 \u540e\u518d\u6309\u4e0b X \u952e\u5373\u53ef\u9000\u51fa QEMU\u3002 4.5 \u4f7f\u7528 GDB \u5bf9\u5185\u6838\u8fdb\u884c\u8c03\u8bd5 \u8fd9\u4e00\u6b65\u9700\u8981\u5f00\u542f\u4e24\u4e2a Terminal Session\uff0c\u4e00\u4e2a Terminal \u4f7f\u7528 QEMU \u542f\u52a8 Linux\uff0c\u53e6\u4e00\u4e2a Terminal \u4f7f\u7528 GDB \u4e0e QEMU \u8fdc\u7a0b\u901a\u4fe1\uff08\u4f7f\u7528 tcp::1234 \u7aef\u53e3\uff09\u8fdb\u884c\u8c03\u8bd5\u3002 1 2 3 4 5 6 7 8 9 10 11 # Terminal 1 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = path/to/rootfs.img,format = raw,id = hd0 -S -s # Terminal 2 $ gdb-multiarch path/to/linux/vmlinux ( gdb ) target remote :1234 # \u8fde\u63a5 qemu ( gdb ) b start_kernel # \u8bbe\u7f6e\u65ad\u70b9 ( gdb ) continue # \u7ee7\u7eed\u6267\u884c ( gdb ) quit # \u9000\u51fa gdb 5 \u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42 \u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a0\u5206\u3002 \u7f16\u8bd1\u5185\u6838\uff0c\u4f7f\u7528 QEMU \u542f\u52a8\u540e\uff0c\u8fdc\u7a0b\u8fde\u63a5 GDB \u8fdb\u884c\u8c03\u8bd5\uff0c\u5e76\u5c1d\u8bd5\u4f7f\u7528 GDB \u7684\u5404\u9879\u547d\u4ee4\uff08\u5982 backtrace , finish , frame , info , break , display , next , layout \u7b49\uff09\u3002 \u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4 pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff0c\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.4\uff09\uff0c\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff0c\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\u3002 \u601d\u8003\u9898 \u4f7f\u7528 riscv64-elf-gcc \u7f16\u8bd1\u5355\u4e2a .c \u6587\u4ef6 \u4f7f\u7528 riscv64-elf-objdump \u53cd\u6c47\u7f16 1 \u4e2d\u5f97\u5230\u7684\u7f16\u8bd1\u4ea7\u7269 \u8c03\u8bd5 Linux \u65f6: \u5728 GDB \u4e2d\u67e5\u770b\u6c47\u7f16\u4ee3\u7801 \u5728 0x80000000 \u5904\u4e0b\u65ad\u70b9 \u67e5\u770b\u6240\u6709\u5df2\u4e0b\u7684\u65ad\u70b9 \u5728 0x80200000 \u5904\u4e0b\u65ad\u70b9 \u6e05\u9664 0x80000000 \u5904\u7684\u65ad\u70b9 \u7ee7\u7eed\u8fd0\u884c\u76f4\u5230\u89e6\u53d1 0x80200000 \u5904\u7684\u65ad\u70b9 \u5355\u6b65\u8c03\u8bd5\u4e00\u6b21 \u9000\u51fa QEMU \u4f7f\u7528 make \u5de5\u5177\u6e05\u9664 Linux \u7684\u6784\u5efa\u4ea7\u7269 vmlinux \u548c Image \u7684\u5173\u7cfb\u548c\u533a\u522b\u662f\u4ec0\u4e48\uff1f","title":"\u5b9e\u9a8c\u6307\u5bfc\u96f6"},{"location":"lab0/#lab-0-gdb-qemu-64-risc-v-linux","text":"","title":"Lab 0: GDB &amp; QEMU \u8c03\u8bd5 64 \u4f4d RISC-V LINUX"},{"location":"lab0/#1","text":"\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177, \u5b8c\u6210Linux\u5185\u6838\u4ee3\u7801\u7f16\u8bd1 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838 \u719f\u6089GDB\u548cQEMU\u8054\u5408\u8c03\u8bd5","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab0/#2","text":"Ubuntu 22.04 Windows Subsystem for Linux 2 \u5176\u4ed6\u53ef\u884c\u7684\u5e73\u53f0\uff0c\u4f46\u6211\u4eec\u4e0d\u63d0\u4f9b\u6280\u672f\u652f\u6301","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab0/#3","text":"","title":"3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd"},{"location":"lab0/#31-linux","text":"\u5728 Linux \u73af\u5883\u4e0b\uff0c\u4eba\u4eec\u901a\u5e38\u4f7f\u7528\u547d\u4ee4\u884c\u63a5\u53e3\u6765\u5b8c\u6210\u4e0e\u8ba1\u7b97\u673a\u7684\u4ea4\u4e92\u3002\u7ec8\u7aef\uff08Terminal\uff09\u662f\u7528\u4e8e\u5904\u7406\u8be5\u8fc7\u7a0b\u7684\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\uff0c\u901a\u8fc7\u7ec8\u7aef\u4f60\u53ef\u4ee5\u8fd0\u884c\u5404\u79cd\u7a0b\u5e8f\u4ee5\u53ca\u5728\u81ea\u5df1\u7684\u8ba1\u7b97\u673a\u4e0a\u5904\u7406\u6587\u4ef6\u3002\u5728\u7c7b Unix \u7684\u64cd\u4f5c\u7cfb\u7edf\u4e0a\uff0c\u7ec8\u7aef\u53ef\u4ee5\u4e3a\u4f60\u5b8c\u6210\u4e00\u5207\u4f60\u6240\u9700\u8981\u7684\u64cd\u4f5c\u3002\u4e0b\u9762\u6211\u4eec\u4ec5\u5bf9\u5b9e\u9a8c\u4e2d\u6d89\u53ca\u7684\u4e00\u4e9b\u6982\u5ff5\u8fdb\u884c\u4ecb\u7ecd\uff0c\u4f60\u53ef\u4ee5\u901a\u8fc7\u4e0b\u9762\u7684\u94fe\u63a5\u6765\u5bf9\u547d\u4ee4\u884c\u7684\u4f7f\u7528\u8fdb\u884c\u5b66\u4e60\uff1a The Missing Semester of Your CS Education >>Video<< GNU/Linux Command-Line Tools Summary Basics of UNIX","title":"3.1 Linux \u4f7f\u7528\u57fa\u7840"},{"location":"lab0/#32-qemu","text":"","title":"3.2 QEMU \u4f7f\u7528\u57fa\u7840"},{"location":"lab0/#qemu","text":"QEMU \u662f\u4e00\u4e2a\u529f\u80fd\u5f3a\u5927\u7684\u6a21\u62df\u5668\uff0c\u53ef\u4ee5\u5728 x86 \u5e73\u53f0\u4e0a\u6267\u884c\u4e0d\u540c\u67b6\u6784\u4e0b\u7684\u7a0b\u5e8f\u3002\u6211\u4eec\u5b9e\u9a8c\u4e2d\u91c7\u7528 QEMU \u6765\u5b8c\u6210 RISC-V \u67b6\u6784\u7684\u7a0b\u5e8f\u7684\u6a21\u62df\u3002","title":"\u4ec0\u4e48\u662fQEMU"},{"location":"lab0/#qemu_1","text":"\u4ee5\u4ee5\u4e0b\u547d\u4ee4\u4e3a\u4f8b\uff0c\u6211\u4eec\u7b80\u5355\u4ecb\u7ecd QEMU \u7684\u53c2\u6570\u6240\u4ee3\u8868\u7684\u542b\u4e49 1 2 3 4 5 6 7 8 9 $ qemu-system-riscv64 \\ -nographic \\ -machine virt \\ -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 \\ -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default \\ -drive file = rootfs.img,format = raw,id = hd0 \\ -S -s -nographic : \u4e0d\u4f7f\u7528\u56fe\u5f62\u7a97\u53e3\uff0c\u4f7f\u7528\u547d\u4ee4\u884c -machine : \u6307\u5b9a\u8981 emulate \u7684\u673a\u5668\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -machine help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u673a\u5668\u9009\u9879 -kernel : \u6307\u5b9a\u5185\u6838 image -append cmdline : \u4f7f\u7528cmdline\u4f5c\u4e3a\u5185\u6838\u7684\u547d\u4ee4\u884c -device : \u6307\u5b9a\u8981\u6a21\u62df\u7684\u8bbe\u5907\uff0c\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device help \u67e5\u770b\u53ef\u9009\u62e9\u7684\u8bbe\u5907\uff0c\u901a\u8fc7\u547d\u4ee4 qemu-system-riscv64 -device <\u5177\u4f53\u7684\u8bbe\u5907>,help \u67e5\u770b\u67d0\u4e2a\u8bbe\u5907\u7684\u547d\u4ee4\u9009\u9879 -drive, file=<file_name> : \u4f7f\u7528 file_name \u4f5c\u4e3a\u6587\u4ef6\u7cfb\u7edf -S : \u542f\u52a8\u65f6\u6682\u505cCPU\u6267\u884c -s : -gdb tcp::1234 \u7684\u7b80\u5199 -bios default : \u4f7f\u7528\u9ed8\u8ba4\u7684 OpenSBI firmware \u4f5c\u4e3a bootloader \u66f4\u591a\u53c2\u6570\u4fe1\u606f\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc","title":"\u5982\u4f55\u4f7f\u7528 QEMU\uff08\u5e38\u89c1\u53c2\u6570\u4ecb\u7ecd\uff09"},{"location":"lab0/#33-gdb","text":"","title":"3.3 GDB \u4f7f\u7528\u57fa\u7840"},{"location":"lab0/#gdb","text":"GNU \u8c03\u8bd5\u5668\uff08\u82f1\u8bed\uff1aGNU Debugger\uff0c\u7f29\u5199\uff1agdb\uff09\u662f\u4e00\u4e2a\u7531 GNU \u5f00\u6e90\u7ec4\u7ec7\u53d1\u5e03\u7684\u3001UNIX/LINUX \u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u3001\u57fa\u4e8e\u547d\u4ee4\u884c\u7684\u3001\u529f\u80fd\u5f3a\u5927\u7684\u7a0b\u5e8f\u8c03\u8bd5\u5de5\u5177\u3002\u501f\u52a9\u8c03\u8bd5\u5668\uff0c\u6211\u4eec\u80fd\u591f\u67e5\u770b\u53e6\u4e00\u4e2a\u7a0b\u5e8f\u5728\u6267\u884c\u65f6\u5b9e\u9645\u5728\u505a\u4ec0\u4e48\uff08\u6bd4\u5982\u8bbf\u95ee\u54ea\u4e9b\u5185\u5b58\u3001\u5bc4\u5b58\u5668\uff09\uff0c\u5728\u5176\u4ed6\u7a0b\u5e8f\u5d29\u6e83\u7684\u65f6\u5019\u53ef\u4ee5\u6bd4\u8f83\u5feb\u901f\u5730\u4e86\u89e3\u5bfc\u81f4\u7a0b\u5e8f\u5d29\u6e83\u7684\u539f\u56e0\u3002 \u88ab\u8c03\u8bd5\u7684\u7a0b\u5e8f\u53ef\u4ee5\u548c GDB \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u5e76\u7531 GDB \u63a7\u5236\uff08\u672c\u5730\u8c03\u8bd5 native debug\uff09\u3002\u4e5f\u53ef\u4ee5\u53ea\u548c gdb-server \u8fd0\u884c\u5728\u540c\u4e00\u53f0\u673a\u5668\u4e0a\uff0c\u7531\u8fde\u63a5\u7740 gdb-server \u7684 GDB \u8fdb\u884c\u63a7\u5236\uff08\u8fdc\u7a0b\u8c03\u8bd5 remote debug\uff09\u3002 GDB \u7684\u529f\u80fd\u5341\u5206\u5f3a\u5927\uff0c\u6211\u4eec\u7ecf\u5e38\u5728\u8c03\u8bd5\u4e2d\u7528\u5230\u7684\u6709: \u542f\u52a8\u7a0b\u5e8f\uff0c\u5e76\u6307\u5b9a\u53ef\u80fd\u5f71\u54cd\u5176\u884c\u4e3a\u7684\u6240\u6709\u5185\u5bb9 \u4f7f\u7a0b\u5e8f\u5728\u6307\u5b9a\u6761\u4ef6\u4e0b\u505c\u6b62 \u68c0\u67e5\u7a0b\u5e8f\u505c\u6b62\u65f6\u53d1\u751f\u4e86\u4ec0\u4e48 \u66f4\u6539\u7a0b\u5e8f\u4e2d\u7684\u5185\u5bb9\uff0c\u4ee5\u4fbf\u7ea0\u6b63\u4e00\u4e2abug\u7684\u5f71\u54cd","title":"\u4ec0\u4e48\u662f GDB"},{"location":"lab0/#gdb_1","text":"(gdb) layout asm : \u663e\u793a\u6c47\u7f16\u4ee3\u7801 (gdb) start : \u5355\u6b65\u6267\u884c\uff0c\u8fd0\u884c\u7a0b\u5e8f\uff0c\u505c\u5728\u7b2c\u4e00\u6267\u884c\u8bed\u53e5 (gdb) continue : \u4ece\u65ad\u70b9\u540e\u7ee7\u7eed\u6267\u884c\uff0c\u7b80\u5199 c (gdb) next : \u5355\u6b65\u8c03\u8bd5\uff08\u9010\u8fc7\u7a0b\uff0c\u51fd\u6570\u76f4\u63a5\u6267\u884c\uff09\uff0c\u7b80\u5199 n (gdb) step instruction : \u6267\u884c\u5355\u6761\u6307\u4ee4\uff0c\u7b80\u5199 si (gdb) run : \u91cd\u65b0\u5f00\u59cb\u8fd0\u884c\u6587\u4ef6\uff08run-text\uff1a\u52a0\u8f7d\u6587\u672c\u6587\u4ef6\uff0crun-bin\uff1a\u52a0\u8f7d\u4e8c\u8fdb\u5236\u6587\u4ef6\uff09\uff0c\u7b80\u5199 r (gdb) backtrace \uff1a\u67e5\u770b\u51fd\u6570\u7684\u8c03\u7528\u7684\u6808\u5e27\u548c\u5c42\u7ea7\u5173\u7cfb\uff0c\u7b80\u5199 bt (gdb) break \u8bbe\u7f6e\u65ad\u70b9\uff0c\u7b80\u5199 b \u65ad\u5728 foo \u51fd\u6570\uff1a b foo \u65ad\u5728\u67d0\u5730\u5740: b * 0x80200000 (gdb) finish : \u7ed3\u675f\u5f53\u524d\u51fd\u6570\uff0c\u8fd4\u56de\u5230\u51fd\u6570\u8c03\u7528\u70b9 (gdb) frame : \u5207\u6362\u51fd\u6570\u7684\u6808\u5e27\uff0c\u7b80\u5199 f (gdb) print : \u6253\u5370\u503c\u53ca\u5730\u5740\uff0c\u7b80\u5199 p (gdb) info : \u67e5\u770b\u51fd\u6570\u5185\u90e8\u5c40\u90e8\u53d8\u91cf\u7684\u6570\u503c\uff0c\u7b80\u5199 i \u67e5\u770b\u5bc4\u5b58\u5668 ra \u7684\u503c: i r ra (gdb) display : \u8ffd\u8e2a\u67e5\u770b\u5177\u4f53\u53d8\u91cf\u503c (gdb) x/4x <addr> : \u4ee5 16 \u8fdb\u5236\u6253\u5370 <addr> \u5904\u5f00\u59cb\u7684 16 Bytes \u5185\u5bb9 \u66f4\u591a\u547d\u4ee4\u53ef\u4ee5\u53c2\u8003 100\u4e2agdb\u5c0f\u6280\u5de7","title":"GDB \u57fa\u672c\u547d\u4ee4\u4ecb\u7ecd"},{"location":"lab0/#34-linux","text":"","title":"3.4 Linux \u5185\u6838\u7f16\u8bd1\u57fa\u7840"},{"location":"lab0/#_1","text":"\u4ea4\u53c9\u7f16\u8bd1\u6307\u7684\u662f\u5728\u4e00\u4e2a\u5e73\u53f0\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728\u53e6\u4e00\u4e2a\u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\u3002\u4f8b\u5982\u5728 x86 \u673a\u5668\u4e0a\u7f16\u8bd1\u53ef\u4ee5\u5728 RISC-V \u67b6\u6784\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u4ea4\u53c9\u7f16\u8bd1\u9700\u8981\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u7684\u652f\u6301\uff0c\u5728\u6211\u4eec\u7684\u5b9e\u9a8c\u4e2d\u6240\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u5c31\u662f riscv-gnu-toolchain \u3002","title":"\u4ea4\u53c9\u7f16\u8bd1"},{"location":"lab0/#_2","text":"\u5185\u6838\u914d\u7f6e\u662f\u7528\u4e8e\u914d\u7f6e\u662f\u5426\u542f\u7528\u5185\u6838\u7684\u5404\u9879\u7279\u6027\uff0c\u5185\u6838\u4f1a\u63d0\u4f9b\u4e00\u4e2a\u540d\u4e3a defconfig (\u5373default configuration) \u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u8be5\u914d\u7f6e\u6587\u4ef6\u4f4d\u4e8e\u5404\u4e2a\u67b6\u6784\u76ee\u5f55\u7684 configs \u6587\u4ef6\u5939\u4e0b\uff0c\u4f8b\u5982\u5bf9\u4e8eRISC-V\u800c\u8a00\uff0c\u5176\u9ed8\u8ba4\u914d\u7f6e\u6587\u4ef6\u4e3a arch/riscv/configs/defconfig \u3002\u4f7f\u7528 make ARCH=riscv defconfig \u547d\u4ee4\u53ef\u4ee5\u5728\u5185\u6838\u6839\u76ee\u5f55\u4e0b\u751f\u6210\u4e00\u4e2a\u540d\u4e3a .config \u7684\u6587\u4ef6\uff0c\u5305\u542b\u4e86\u5185\u6838\u5b8c\u6574\u7684\u914d\u7f6e\uff0c\u5185\u6838\u5728\u7f16\u8bd1\u65f6\u4f1a\u6839\u636e .config \u8fdb\u884c\u7f16\u8bd1\u3002 \u914d\u7f6e\u4e4b\u95f4\u5b58\u5728\u76f8\u4e92\u7684\u4f9d\u8d56\u5173\u7cfb\uff0c\u76f4\u63a5\u4fee\u6539defconfig\u6587\u4ef6\u6216\u8005 .config \u6709\u65f6\u5019\u5e76\u4e0d\u80fd\u8fbe\u5230\u60f3\u8981\u7684\u6548\u679c\uff0c\u6216\u662f\u7ed9\u8fdb\u4e00\u6b65\u5185\u6838\u914d\u7f6e\u5e26\u6765\u540c\u6b65\u95ee\u9898\u3002\u56e0\u6b64\u5982\u679c\u9700\u8981\u4fee\u6539\u914d\u7f6e\u4e00\u822c\u91c7\u7528 make ARCH=riscv menuconfig \u7684\u65b9\u5f0f\u5bf9\u5185\u6838\u8fdb\u884c\u914d\u7f6e\u3002","title":"\u5185\u6838\u914d\u7f6e"},{"location":"lab0/#_3","text":"make \u662f\u7528\u4e8e\u7a0b\u5e8f\u6784\u5efa\u7684\u91cd\u8981\u5de5\u5177\uff0c\u5b83\u7684\u884c\u4e3a\u7531\u5f53\u524d\u76ee\u5f55\u6216 make -C \u6307\u5b9a\u76ee\u5f55\u4e0b\u7684 Makefile \u6765\u51b3\u5b9a\u3002\u66f4\u591a\u6709\u5173 Makefile \u7684\u5185\u5bb9\u53ef\u4ee5\u53c2\u8003 Learn Makefiles With the tastiest examples \u3002\u4e0b\u9762\u7528\u672c\u6b21\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u7528\u5230\u7684\u7528\u4e8e\u7f16\u8bd1 Linux \u5185\u6838\u7684\u7f16\u8bd1\u547d\u4ee4\u4f5c\u4e3a\u793a\u4f8b\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 $ make help # \u67e5\u770bmake\u547d\u4ee4\u7684\u5404\u79cd\u53c2\u6570\u89e3\u91ca $ make <target-name> # \u7f16\u8bd1\u540d\u4e3a <target-name> \u7684\u76ee\u6807\u6587\u4ef6\u6216\u76ee\u6807\u4efb\u52a1 $ make defconfig # \u4f7f\u7528\u5f53\u524d\u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e\uff0c\u5728x86\u673a\u5668\u4e0a\u4f1a\u4f7f\u7528x86\u7684\u9ed8\u8ba4\u914d\u7f6e $ make clean # \u6e05\u9664\u6240\u6709\u7f16\u8bd1\u597d\u7684 object \u6587\u4ef6 $ make mrproper # \u5220\u9664\u6240\u6709\u7f16\u8bd1\u4ea7\u7269\u548c\u914d\u7f6e\u6587\u4ef6 $ make -j<thread-count> # \u4f7f\u7528 <thread-count> \u4e2a\u7269\u7406\u7ebf\u7a0b\u6765\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make -j4 # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j4 \u4e3a\u4f7f\u7528 4 \u7ebf\u7a0b\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make -j $( nproc ) # \u7f16\u8bd1\u5f53\u524d\u5e73\u53f0\u7684\u5185\u6838\uff0c-j$(nproc) \u4e3a\u4ee5\u5168\u90e8\u673a\u5668\u786c\u4ef6\u7ebf\u7a0b\u6570\u8fdb\u884c\u591a\u7ebf\u7a0b\u7f16\u8bd1 $ make <var-name> = <var-value> # \u5728\u7f16\u8bd1\u8fc7\u7a0b\u4e2d\u5c06 <var-name> \u53d8\u91cf\u7684\u503c\u624b\u52a8\u8bbe\u7f6e\u4e3a <val-value> $ make ARCH = riscv defconfig # \u4f7f\u7528 RISC-V \u5e73\u53f0\u7684\u9ed8\u8ba4\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- # \u7f16\u8bd1 RISC-V \u5e73\u53f0\u5185\u6838 \u6211\u4eec\u53ef\u4ee5\u624b\u52a8\u4e3a make \u6307\u5b9a\u53d8\u91cf\u7684\u503c\uff0c\u672c\u6b21\u5b9e\u9a8c\u4e2d\u7528\u5230\u7684\u5982\u4e0b\uff1a ARCH \u6307\u5b9a\u67b6\u6784\uff0c\u53ef\u9009\u7684\u503c\u5305\u62ec arch \u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u5939\u540d\uff0c\u5982 x86\u3001arm\u3001arm64 \u7b49\uff0c\u4e0d\u540c\u4e8e arm \u548c arm64\uff0c32 \u4f4d\u548c 64 \u4f4d\u7684RISC-V\u5171\u7528 arch/riscv \u76ee\u5f55\uff0c\u901a\u8fc7\u4f7f\u7528\u4e0d\u540c\u7684 config \u53ef\u4ee5\u7f16\u8bd1 32 \u4f4d\u6216 64 \u4f4d\u7684\u5185\u6838\u3002 CROSS_COMPILE \u6307\u5b9a\u4f7f\u7528\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\uff0c\u4f8b\u5982\u6307\u5b9a CROSS_COMPILE=riscv64-linux-gnu- \uff0c\u5219\u7f16\u8bd1\u65f6\u4f1a\u91c7\u7528 riscv64-linux-gnu-gcc \u4f5c\u4e3a\u7f16\u8bd1\u5668\uff0c\u7f16\u8bd1\u5728 RISC-V 64 \u4f4d\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u3002","title":"\u7f16\u8bd1\u5de5\u5177"},{"location":"lab0/#4","text":"\u5728\u6267\u884c\u6bcf\u4e00\u6761\u547d\u4ee4\u524d\uff0c\u8bf7\u4f60\u5bf9\u5c06\u8981\u8fdb\u884c\u7684\u64cd\u4f5c\u8fdb\u884c\u601d\u8003\uff0c\u7ed9\u51fa\u7684\u547d\u4ee4\u4e0d\u9700\u8981\u5168\u90e8\u6267\u884c\uff0c\u5e76\u4e14\u4e0d\u662f\u6240\u6709\u7684\u547d\u4ee4\u90fd\u53ef\u4ee5\u65e0\u6761\u4ef6\u6267\u884c\uff0c\u8bf7\u4e0d\u8981\u76f4\u63a5\u590d\u5236\u7c98\u8d34\u547d\u4ee4\u53bb\u6267\u884c\u3002","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab0/#41","text":"\u9996\u5148\u5b89\u88c5\u7f16\u8bd1\u5185\u6838\u6240\u9700\u8981\u7684\u4ea4\u53c9\u7f16\u8bd1\u5de5\u5177\u94fe\u548c\u7528\u4e8e\u6784\u5efa\u7a0b\u5e8f\u7684\u8f6f\u4ef6\u5305 1 2 3 4 $ sudo apt install gcc-riscv64-linux-gnu $ sudo apt install autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev \\ gawk build-essential bison flex texinfo gperf libtool patchutils bc \\ zlib1g-dev libexpat-dev git \u63a5\u7740\u662f\u7528\u4e8e\u542f\u52a8 riscv64 \u5e73\u53f0\u4e0a\u7684\u5185\u6838\u7684\u6a21\u62df\u5668 qemu 1 $ sudo apt install qemu-system-misc \u6211\u4eec\u8fd8\u9700\u8981\u7528 gdb \u6765\u5bf9\u5728 qemu \u4e0a\u8fd0\u884c\u7684 Linux \u5185\u6838\u8fdb\u884c\u8c03\u8bd5 1 $ sudo apt install gdb-multiarch","title":"4.1 \u642d\u5efa\u5b9e\u9a8c\u73af\u5883\u73af\u5883"},{"location":"lab0/#42-linux","text":"\u4ece https://www.kernel.org \u4e0b\u8f7d\u6700\u65b0\u7684 Linux \u6e90\u7801\u3002 \u622a\u81f3\u5199\u4f5c\u65f6\uff0c\u6700\u65b0\u7684 Linux \u5185\u6838\u7248\u672c\u662f 6.0rc5. \u5e76\u4e14\u4f7f\u7528 git \u5de5\u5177 clone \u672c\u4ed3\u5e93 \u3002\u5176\u4e2d\u5df2\u7ecf\u51c6\u5907\u597d\u4e86\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf\u3002 \u6839\u6587\u4ef6\u7cfb\u7edf\u4e3a Linux Kernel \u63d0\u4f9b\u4e86\u57fa\u7840\u7684\u6587\u4ef6\u670d\u52a1\uff0c\u5728\u542f\u52a8 Linux Kernel \u65f6\u662f\u5fc5\u8981\u7684\u3002 1 2 3 4 $ git clone https://gitee.com/zjusec/os22fall-stu $ cd os22fall-stu/src/lab0 $ ls rootfs.img # \u5df2\u7ecf\u6784\u5efa\u5b8c\u6210\u7684\u6839\u6587\u4ef6\u7cfb\u7edf\u7684\u955c\u50cf","title":"4.2 \u83b7\u53d6 Linux \u6e90\u7801\u548c\u5df2\u7ecf\u7f16\u8bd1\u597d\u7684\u6587\u4ef6\u7cfb\u7edf"},{"location":"lab0/#43-linux","text":"1 2 3 $ cd path/to/linux $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- defconfig # \u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e $ make ARCH = riscv CROSS_COMPILE = riscv64-linux-gnu- -j $( nproc ) # \u7f16\u8bd1 \u4f7f\u7528\u591a\u7ebf\u7a0b\u7f16\u8bd1\u4e00\u822c\u4f1a\u8017\u8d39\u5927\u91cf\u5185\u5b58\uff0c\u5982\u679c -j \u9009\u9879\u5bfc\u81f4\u5185\u5b58\u8017\u5c3d (out of memory)\uff0c\u8bf7\u5c1d\u8bd5\u8c03\u4f4e\u7ebf\u7a0b\u6570\uff0c\u6bd4\u5982 -j4 , -j8 \u7b49\u3002","title":"4.3 \u7f16\u8bd1 linux \u5185\u6838"},{"location":"lab0/#44-qemu","text":"1 2 3 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = path/to/rootfs.img,format = raw,id = hd0 \u9000\u51fa QEMU \u7684\u65b9\u6cd5\u4e3a\uff1a\u4f7f\u7528 Ctrl+A\uff0c \u677e\u5f00 \u540e\u518d\u6309\u4e0b X \u952e\u5373\u53ef\u9000\u51fa QEMU\u3002","title":"4.4 \u4f7f\u7528QEMU\u8fd0\u884c\u5185\u6838"},{"location":"lab0/#45-gdb","text":"\u8fd9\u4e00\u6b65\u9700\u8981\u5f00\u542f\u4e24\u4e2a Terminal Session\uff0c\u4e00\u4e2a Terminal \u4f7f\u7528 QEMU \u542f\u52a8 Linux\uff0c\u53e6\u4e00\u4e2a Terminal \u4f7f\u7528 GDB \u4e0e QEMU \u8fdc\u7a0b\u901a\u4fe1\uff08\u4f7f\u7528 tcp::1234 \u7aef\u53e3\uff09\u8fdb\u884c\u8c03\u8bd5\u3002 1 2 3 4 5 6 7 8 9 10 11 # Terminal 1 $ qemu-system-riscv64 -nographic -machine virt -kernel path/to/linux/arch/riscv/boot/Image \\ -device virtio-blk-device,drive = hd0 -append \"root=/dev/vda ro console=ttyS0\" \\ -bios default -drive file = path/to/rootfs.img,format = raw,id = hd0 -S -s # Terminal 2 $ gdb-multiarch path/to/linux/vmlinux ( gdb ) target remote :1234 # \u8fde\u63a5 qemu ( gdb ) b start_kernel # \u8bbe\u7f6e\u65ad\u70b9 ( gdb ) continue # \u7ee7\u7eed\u6267\u884c ( gdb ) quit # \u9000\u51fa gdb","title":"4.5 \u4f7f\u7528 GDB \u5bf9\u5185\u6838\u8fdb\u884c\u8c03\u8bd5"},{"location":"lab0/#5","text":"\u8bf7\u5404\u4f4d\u540c\u5b66\u72ec\u7acb\u5b8c\u6210\u4f5c\u4e1a\uff0c\u4efb\u4f55\u6284\u88ad\u884c\u4e3a\u90fd\u5c06\u4f7f\u672c\u6b21\u4f5c\u4e1a\u5224\u4e3a0\u5206\u3002 \u7f16\u8bd1\u5185\u6838\uff0c\u4f7f\u7528 QEMU \u542f\u52a8\u540e\uff0c\u8fdc\u7a0b\u8fde\u63a5 GDB \u8fdb\u884c\u8c03\u8bd5\uff0c\u5e76\u5c1d\u8bd5\u4f7f\u7528 GDB \u7684\u5404\u9879\u547d\u4ee4\uff08\u5982 backtrace , finish , frame , info , break , display , next , layout \u7b49\uff09\u3002 \u5728\u5b66\u5728\u6d59\u5927\u4e2d\u63d0\u4ea4 pdf \u683c\u5f0f\u7684\u5b9e\u9a8c\u62a5\u544a\uff0c\u8bb0\u5f55\u5b9e\u9a8c\u8fc7\u7a0b\u5e76\u622a\u56fe\uff084.1-4.4\uff09\uff0c\u5bf9\u6bcf\u4e00\u6b65\u7684\u547d\u4ee4\u4ee5\u53ca\u7ed3\u679c\u8fdb\u884c\u5fc5\u8981\u7684\u89e3\u91ca\uff0c\u8bb0\u5f55\u9047\u5230\u7684\u95ee\u9898\u548c\u5fc3\u5f97\u4f53\u4f1a\u3002","title":"5 \u5b9e\u9a8c\u4efb\u52a1\u4e0e\u8981\u6c42"},{"location":"lab0/#_4","text":"\u4f7f\u7528 riscv64-elf-gcc \u7f16\u8bd1\u5355\u4e2a .c \u6587\u4ef6 \u4f7f\u7528 riscv64-elf-objdump \u53cd\u6c47\u7f16 1 \u4e2d\u5f97\u5230\u7684\u7f16\u8bd1\u4ea7\u7269 \u8c03\u8bd5 Linux \u65f6: \u5728 GDB \u4e2d\u67e5\u770b\u6c47\u7f16\u4ee3\u7801 \u5728 0x80000000 \u5904\u4e0b\u65ad\u70b9 \u67e5\u770b\u6240\u6709\u5df2\u4e0b\u7684\u65ad\u70b9 \u5728 0x80200000 \u5904\u4e0b\u65ad\u70b9 \u6e05\u9664 0x80000000 \u5904\u7684\u65ad\u70b9 \u7ee7\u7eed\u8fd0\u884c\u76f4\u5230\u89e6\u53d1 0x80200000 \u5904\u7684\u65ad\u70b9 \u5355\u6b65\u8c03\u8bd5\u4e00\u6b21 \u9000\u51fa QEMU \u4f7f\u7528 make \u5de5\u5177\u6e05\u9664 Linux \u7684\u6784\u5efa\u4ea7\u7269 vmlinux \u548c Image \u7684\u5173\u7cfb\u548c\u533a\u522b\u662f\u4ec0\u4e48\uff1f","title":"\u601d\u8003\u9898"},{"location":"lab1/","text":"Lab 1: RV64 \u5185\u6838\u5f15\u5bfc 1 \u5b9e\u9a8c\u76ee\u7684 \u5b66\u4e60 RISC-V \u6c47\u7f16\uff0c \u7f16\u5199 head.S \u5b9e\u73b0\u8df3\u8f6c\u5230\u5185\u6838\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u3002 \u5b66\u4e60 OpenSBI\uff0c\u7406\u89e3 OpenSBI \u5728\u5b9e\u9a8c\u4e2d\u6240\u8d77\u5230\u7684\u4f5c\u7528\uff0c\u5e76\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5b57\u7b26\u7684\u8f93\u51fa\u3002 \u5b66\u4e60 Makefile \u76f8\u5173\u77e5\u8bc6\uff0c \u8865\u5145\u9879\u76ee\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c \u6765\u5b8c\u6210\u5bf9\u6574\u4e2a\u5de5\u7a0b\u7684\u7ba1\u7406\u3002 2 \u5b9e\u9a8c\u73af\u5883 Environment in Lab0 3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd 3.1 \u524d\u7f6e\u77e5\u8bc6 \u4e3a\u4e86\u987a\u5229\u5b8c\u6210 OS \u5b9e\u9a8c\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u524d\u7f6e\u77e5\u8bc6\u548c\u8f83\u591a\u8c03\u8bd5\u6280\u5de7\u3002\u5728 OS \u5b9e\u9a8c\u4e2d\u6211\u4eec\u9700\u8981 RISC-V\u6c47\u7f16 \u7684\u524d\u7f6e\u77e5\u8bc6\uff0c\u8bfe\u5802\u4e0a\u4e0d\u4f1a\u8bb2\u6388\uff0c\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7\u9605\u8bfb\u4ee5\u4e0b\u56db\u4efd\u6587\u6863\u81ea\u5b66\uff1a RISC-V Assembly Programmer's Manual RISC-V Unprivileged Spec RISC-V Privileged Spec RISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09 \u6ce8\uff1aRISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09\u4e2d\u6709\u4e00\u4e9b Typo\uff0c\u8bf7\u8c28\u614e\u53c2\u8003\u3002 3.2 RISC-V \u7684\u4e09\u79cd\u7279\u6743\u6a21\u5f0f RISC-V \u6709\u4e09\u4e2a\u7279\u6743\u6a21\u5f0f\uff1aU (user) \u6a21\u5f0f\u3001S (supervisor) \u6a21\u5f0f\u548c M (machine) \u6a21\u5f0f\u3002 Level Encoding Name Abbreviation 0 00 User/Application U 1 01 Supervisor S 2 10 Reserved 3 11 Machine M \u5176\u4e2d\uff1a M \u6a21\u5f0f\u662f\u5bf9\u786c\u4ef6\u64cd\u4f5c\u7684\u62bd\u8c61\uff0c\u6709 \u6700\u9ad8 \u7ea7\u522b\u7684\u6743\u9650 S \u6a21\u5f0f\u4ecb\u4e8e M \u6a21\u5f0f\u548c U \u6a21\u5f0f\u4e4b\u95f4\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u5185\u6838\u6001 (Kernel)\u3002\u5f53\u7528\u6237\u9700\u8981\u5185\u6838\u8d44\u6e90\u65f6\uff0c\u5411\u5185\u6838\u7533\u8bf7\uff0c\u5e76\u5207\u6362\u5230\u5185\u6838\u6001\u8fdb\u884c\u5904\u7406 U \u6a21\u5f0f\u7528\u4e8e\u6267\u884c\u7528\u6237\u7a0b\u5e8f\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u7528\u6237\u6001\uff0c\u6709 \u6700\u4f4e \u7ea7\u522b\u7684\u6743\u9650 3.3 \u4ece\u8ba1\u7b97\u673a\u4e0a\u7535\u5230 OS \u8fd0\u884c \u6211\u4eec\u4ee5\u6700\u57fa\u7840\u7684\u5d4c\u5165\u5f0f\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u8ba1\u7b97\u673a\u4e0a\u7535\u540e\uff0c\u9996\u5148\u786c\u4ef6\u8fdb\u884c\u4e00\u4e9b\u57fa\u7840\u7684\u521d\u59cb\u5316\u540e\uff0c\u5c06 CPU \u7684 Program Counter \u79fb\u52a8\u5230\u5185\u5b58\u4e2d Bootloader \u7684\u8d77\u59cb\u5730\u5740\u3002 Bootloader \u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\uff0c\u7528\u4e8e\u521d\u59cb\u5316\u786c\u4ef6\uff0c\u52a0\u8f7d\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002 \u5728 RISC-V \u67b6\u6784\u91cc\uff0cBootloader \u8fd0\u884c\u5728 M \u6a21\u5f0f\u4e0b\u3002Bootloader \u8fd0\u884c\u5b8c\u6bd5\u540e\u5c31\u4f1a\u628a\u5f53\u524d\u6a21\u5f0f\u5207\u6362\u5230 S \u6a21\u5f0f\u4e0b\uff0c\u673a\u5668\u968f\u540e\u5f00\u59cb\u8fd0\u884c Kernel\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u7b80\u5355\u800c\u8a00\u5c31\u662f\u8fd9\u6837\uff1a 1 2 3 4 Hardware RISC-V M Mode RISC-V S Mode +------------+ +--------------+ +----------+ | Power On | ----> | Bootloader | ----> | Kernel | +------------+ +--------------+ +----------+ 3.4 SBI \u4e0e OpenSBI SBI (Supervisor Binary Interface) \u662f S-mode \u7684 Kernel \u548c M-mode \u6267\u884c\u73af\u5883\u4e4b\u95f4\u7684\u63a5\u53e3\u89c4\u8303\uff0c\u800c OpenSBI \u662f\u4e00\u4e2a RISC-V SBI \u89c4\u8303\u7684\u5f00\u6e90\u5b9e\u73b0\u3002RISC-V \u5e73\u53f0\u548c SoC \u4f9b\u5e94\u5546\u53ef\u4ee5\u81ea\u4e3b\u6269\u5c55 OpenSBI \u5b9e\u73b0\uff0c\u4ee5\u9002\u5e94\u7279\u5b9a\u7684\u786c\u4ef6\u914d\u7f6e\u3002 \u7b80\u5355\u7684\u8bf4\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u9002\u914d\u4e0d\u540c\u786c\u4ef6\uff0cOpenSBI \u63d0\u51fa\u4e86\u4e00\u7cfb\u5217\u89c4\u8303\u5bf9 M-mode \u4e0b\u7684\u786c\u4ef6\u8fdb\u884c\u4e86\u7edf\u4e00\u5b9a\u4e49\uff0c\u8fd0\u884c\u5728 S-mode \u4e0b\u7684\u5185\u6838\u53ef\u4ee5\u6309\u7167\u8fd9\u4e9b\u89c4\u8303\u5bf9\u4e0d\u540c\u786c\u4ef6\u8fdb\u884c\u64cd\u4f5c\u3002 \u4e3a\u964d\u4f4e\u5b9e\u9a8c\u96be\u5ea6\uff0c\u6211\u4eec\u9009\u62e9 OpenSBI \u4f5c\u4e3a Bootloader \u6765\u5b8c\u6210\u673a\u5668\u542f\u52a8\u65f6 M-mode \u4e0b\u7684\u786c\u4ef6\u521d\u59cb\u5316\u4e0e\u5bc4\u5b58\u5668\u8bbe\u7f6e\uff0c\u5e76\u4f7f\u7528 OpenSBI \u6240\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u8bf8\u5982\u5b57\u7b26\u6253\u5370\u7684\u64cd\u4f5c\u3002 \u5728\u5b9e\u9a8c\u4e2d\uff0cQEMU \u5df2\u7ecf\u5185\u7f6e\u4e86 OpenSBI \u4f5c\u4e3a Bootloader\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 -bios default \u542f\u7528\u3002\u5982\u679c\u542f\u7528\uff0cQEMU \u4f1a\u5c06 OpenSBI \u4ee3\u7801\u52a0\u8f7d\u5230 0x80000000 \u8d77\u59cb\u5904\u3002OpenSBI \u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u4f1a\u8df3\u8f6c\u5230 0x80200000 \u5904\uff08\u4e5f\u5c31\u662f Kernel \u7684\u8d77\u59cb\u5730\u5740\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6240\u7f16\u8bd1\u7684\u4ee3\u7801\u9700\u8981\u653e\u5230 0x80200000 \u5904\u3002 \u5982\u679c\u4f60\u5bf9 RISC-V \u67b6\u6784\u7684 Boot \u6d41\u7a0b\u6709\u66f4\u591a\u7684\u597d\u5947\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4efd bootflow \u3002 3.5 Makefile Makefile \u53ef\u4ee5\u7b80\u5355\u7684\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5de5\u7a0b\u6587\u4ef6\u7684\u7f16\u8bd1\u89c4\u5219\uff0c\u63cf\u8ff0\u4e86\u6574\u4e2a\u5de5\u7a0b\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\u6d41\u7a0b\u3002\u5728 Lab0 \u4e2d\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u4e86 make \u5de5\u5177\u5229\u7528 Makefile \u6587\u4ef6\u6765\u7ba1\u7406\u6574\u4e2a\u5de5\u7a0b\u3002\u5728\u9605\u8bfb\u4e86 Makefile\u4ecb\u7ecd \u8fd9\u4e00\u7ae0\u8282\u540e\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u5de5\u7a0b\u6587\u4ef6\u5939\u91cc Makefile \u7684\u4ee3\u7801\u6765\u638c\u63e1\u4e00\u4e9b\u57fa\u672c\u7684\u4f7f\u7528\u6280\u5de7\u3002 3.6 \u5185\u8054\u6c47\u7f16 \u5185\u8054\u6c47\u7f16\uff08\u901a\u5e38\u7531 asm \u6216\u8005 __asm__ \u5173\u952e\u5b57\u5f15\u5165\uff09\u63d0\u4f9b\u4e86\u5c06\u6c47\u7f16\u8bed\u8a00\u6e90\u4ee3\u7801\u5d4c\u5165 C \u7a0b\u5e8f\u7684\u80fd\u529b\u3002 \u5185\u8054\u6c47\u7f16\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Assembler Instructions with C Expression Operands \u3002 \u4e0b\u9762\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u6b21\u5b9e\u9a8c\u4f1a\u7528\u5230\u7684\u4e00\u4e9b\u5185\u8054\u6c47\u7f16\u77e5\u8bc6\uff1a \u5185\u8054\u6c47\u7f16\u57fa\u672c\u683c\u5f0f\u4e3a\uff1a 1 2 3 4 5 6 7 8 9 10 __asm__ volatile ( \"instruction1 \\n \" \"instruction2 \\n \" ...... ...... \"instruction3 \\n \" : [ out1 ] \"=r\" ( v1 ),[ out2 ] \"=r\" ( v2 ) : [ in1 ] \"r\" ( v1 ), [ in2 ] \"r\" ( v2 ) : \"memory\" ); \u5176\u4e2d\uff0c\u4e09\u4e2a : \u5c06\u6c47\u7f16\u90e8\u5206\u5206\u6210\u4e86\u56db\u90e8\u5206\uff1a \u7b2c\u4e00\u90e8\u5206\u662f\u6c47\u7f16\u6307\u4ee4\uff0c\u6307\u4ee4\u672b\u5c3e\u9700\u8981\u6dfb\u52a0 '\\n'\u3002 \u7b2c\u4e8c\u90e8\u5206\u662f\u8f93\u51fa\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u4e09\u90e8\u5206\u662f\u8f93\u5165\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u56db\u90e8\u5206\u662f\u53ef\u80fd\u5f71\u54cd\u7684\u5bc4\u5b58\u5668\u6216\u5b58\u50a8\u5668\uff0c\u7528\u4e8e\u544a\u77e5\u7f16\u8bd1\u5668\u5f53\u524d\u5185\u8054\u6c47\u7f16\u8bed\u53e5\u53ef\u80fd\u4f1a\u5bf9\u67d0\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u5f97\u7f16\u8bd1\u5668\u5728\u4f18\u5316\u65f6\u5c06\u5176\u56e0\u7d20\u8003\u8651\u8fdb\u53bb\u3002 \u8fd9\u56db\u90e8\u5206\u4e2d\u540e\u4e09\u90e8\u5206\u4e0d\u662f\u5fc5\u987b\u7684\u3002 \u793a\u4f8b\u4e00 1 2 3 4 5 6 7 8 9 10 11 12 unsigned long long s_example ( unsigned long long type , unsigned long long arg0 ) { unsigned long long ret_val ; __asm__ volatile ( \"mv x10, %[type] \\n \" \"mv x11, %[arg0] \\n \" \"mv %[ret_val], x12\" : [ ret_val ] \"=r\" ( ret_val ) : [ type ] \"r\" ( type ), [ arg0 ] \"r\" ( arg0 ) : \"memory\" ); return ret_val ; } \u793a\u4f8b\u4e00\u4e2d\u6307\u4ee4\u90e8\u5206\uff0c %[type] \u3001 %[arg0] \u4ee5\u53ca %[ret_val] \u4ee3\u8868\u7740\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\u6216\u662f\u5185\u5b58\u3002 \u8f93\u5165\u8f93\u51fa\u90e8\u5206\u4e2d\uff0c [type] \"r\" (type) \u4ee3\u8868\u7740\u5c06 () \u4e2d\u7684\u53d8\u91cf type \u653e\u5165\u5bc4\u5b58\u5668\u4e2d\uff08 \"r\" \u6307\u653e\u5165\u5bc4\u5b58\u5668\uff0c\u5982\u679c\u662f \"m\" \u5219\u4e3a\u653e\u5165\u5185\u5b58\uff09\uff0c\u5e76\u4e14\u7ed1\u5b9a\u5230 [] \u4e2d\u547d\u540d\u7684\u7b26\u53f7\u4e2d\u53bb\u3002 [ret_val] \"=r\" (ret_val) \u4ee3\u8868\u7740\u5c06\u6c47\u7f16\u6307\u4ee4\u4e2d %[ret_val] \u7684\u503c\u66f4\u65b0\u5230\u53d8\u91cf ret_val \u4e2d\u3002 \u793a\u4f8b\u4e8c 1 2 #define write_csr(reg, val) ({ __asm__ volatile ( \"csrw \" # reg \", %0\" :: \"r\" ( val )); }) \u793a\u4f8b\u4e8c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5b8f\uff0c\u5176\u4e2d %0 \u4ee3\u8868\u7740\u8f93\u51fa\u8f93\u5165\u90e8\u5206\u7684\u7b2c\u4e00\u4e2a\u7b26\u53f7\uff0c\u5373 val \u3002 #reg \u662fc\u8bed\u8a00\u7684\u4e00\u4e2a\u7279\u6b8a\u5b8f\u5b9a\u4e49\u8bed\u6cd5\uff0c\u76f8\u5f53\u4e8e\u5c06reg\u8fdb\u884c\u5b8f\u66ff\u6362\u5e76\u7528\u53cc\u5f15\u53f7\u5305\u88f9\u8d77\u6765\u3002 \u4f8b\u5982 write_csr(sstatus,val) \u7ecf\u5b8f\u5c55\u5f00\u4f1a\u5f97\u5230\uff1a 1 2 ({ __asm__ volatile ( \"csrw \" \"sstatus\" \", %0\" :: \"r\" ( val )); }) 3.7 \u7f16\u8bd1\u76f8\u5173\u77e5\u8bc6\u4ecb\u7ecd vmlinux.lds GNU ld \u5373\u94fe\u63a5\u5668\uff0c\u7528\u4e8e\u5c06 *.o \u6587\u4ef6\uff08\u548c\u5e93\u6587\u4ef6\uff09\u94fe\u63a5\u6210\u53ef\u6267\u884c\u6587\u4ef6\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u4e2d\uff0c\u4e3a\u4e86\u6307\u5b9a\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40\uff0cld \u4f7f\u7528\u94fe\u63a5\u811a\u672c\uff08Linker Script\uff09\u6765\u63a7\u5236\uff0c\u5728 Linux Kernel \u4e2d\u94fe\u63a5\u811a\u672c\u88ab\u547d\u540d\u4e3a vmlinux.lds\u3002\u66f4\u591a\u5173\u4e8e ld \u7684\u4ecb\u7ecd\u53ef\u4ee5\u4f7f\u7528 man ld \u547d\u4ee4\u3002 \u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a vmlinux.lds \u7684\u4f8b\u5b50\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 /* \u76ee\u6807\u67b6\u6784 */ OUTPUT_ARCH( \"riscv\" ) /* \u7a0b\u5e8f\u5165\u53e3 */ ENTRY( _start ) /* kernel\u4ee3\u7801\u8d77\u59cb\u4f4d\u7f6e */ BASE_ADDR = 0x80200000; SECTIONS { /* . \u4ee3\u8868\u5f53\u524d\u5730\u5740 */ . = BASE_ADDR; /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u8d77\u59cb\u5730\u5740 */ _skernel = .; /* ALIGN(0x1000) \u8868\u793a4KB\u5bf9\u9f50 */ /* _stext, _etext \u5206\u522b\u8bb0\u5f55\u4e86text\u6bb5\u7684\u8d77\u59cb\u4e0e\u7ed3\u675f\u5730\u5740 */ .text : ALIGN(0x1000){ _stext = .; *(.text.entry) *(.text .text.*) _etext = .; } .rodata : ALIGN(0x1000){ _srodata = .; *(.rodata .rodata.*) _erodata = .; } .data : ALIGN(0x1000){ _sdata = .; *(.data .data.*) _edata = .; } .bss : ALIGN(0x1000){ _sbss = .; *(.bss.stack) sbss = .; *(.bss .bss.*) _ebss = .; } /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u7ed3\u675f\u5730\u5740 */ _ekernel = .; } \u9996\u5148\u6211\u4eec\u4f7f\u7528 OUTPUT_ARCH \u6307\u5b9a\u4e86\u67b6\u6784\u4e3a RISC-V \uff0c\u4e4b\u540e\u4f7f\u7528 ENTRY \u6307\u5b9a\u7a0b\u5e8f\u5165\u53e3\u70b9\u4e3a _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u5165\u53e3\u70b9\u5373\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fd0\u884c\u7684\u51fd\u6570\uff0c\u7ecf\u8fc7\u8fd9\u6837\u7684\u6307\u5b9a\u540e\u5728head.S\u4e2d\u9700\u8981\u7f16\u5199 _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u624d\u80fd\u6b63\u5e38\u8fd0\u884c\u3002 \u94fe\u63a5\u811a\u672c\u4e2d\u6709 . * \u4e24\u4e2a\u91cd\u8981\u7684\u7b26\u53f7\u3002\u5355\u72ec\u7684 . \u5728\u94fe\u63a5\u811a\u672c\u4ee3\u8868\u5f53\u524d\u5730\u5740\uff0c\u5b83\u6709\u8d4b\u503c\u3001\u88ab\u8d4b\u503c\u3001\u81ea\u589e\u7b49\u64cd\u4f5c\u3002\u800c * \u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u5176\u4e00\u662f *() \u5728\u5927\u62ec\u53f7\u4e2d\u8868\u793a\u5c06\u6240\u6709\u6587\u4ef6\u4e2d\u7b26\u5408\u62ec\u53f7\u5185\u8981\u6c42\u7684\u6bb5\u653e\u7f6e\u5728\u5f53\u524d\u4f4d\u7f6e\uff0c\u5176\u4e8c\u662f\u4f5c\u4e3a\u901a\u914d\u7b26\u3002 \u94fe\u63a5\u811a\u672c\u7684\u4e3b\u4f53\u662fSECTIONS\u90e8\u5206\uff0c\u5728\u8fd9\u91cc\u94fe\u63a5\u811a\u672c\u7684\u5de5\u4f5c\u662f\u5c06\u7a0b\u5e8f\u7684\u5404\u4e2a\u6bb5\u6309\u987a\u5e8f\u653e\u5728\u5404\u4e2a\u5730\u5740\u4e0a\uff0c\u5728\u4f8b\u5b50\u4e2d\u5c31\u662f\u4ece0x80200000\u5730\u5740\u5f00\u59cb\u653e\u7f6e\u4e86 .text \uff0c .rodata \uff0c .data \u548c .bss \u6bb5\u3002\u5404\u4e2a\u6bb5\u7684\u4f5c\u7528\u53ef\u4ee5\u7b80\u8981\u6982\u62ec\u6210\uff1a \u6bb5\u540d \u4e3b\u8981\u4f5c\u7528 .text \u901a\u5e38\u5b58\u653e\u7a0b\u5e8f\u6267\u884c\u4ee3\u7801 .rodata \u901a\u5e38\u5b58\u653e\u5e38\u91cf\u7b49\u53ea\u8bfb\u6570\u636e .data \u901a\u5e38\u5b58\u653e\u5df2\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf .bss \u901a\u5e38\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf \u5728\u94fe\u63a5\u811a\u672c\u4e2d\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7b26\u53f7\uff0c\u4f8b\u5982\u4ee5\u4e0a\u6240\u6709 _s \u4e0e _e \u5f00\u5934\u7684\u7b26\u53f7\u90fd\u662f\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u7684\u3002 \u66f4\u591a\u6709\u5173\u94fe\u63a5\u811a\u672c\u8bed\u6cd5\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc \u3002 vmlinux vmlinux \u901a\u5e38\u6307 Linux Kernel \u7f16\u8bd1\u51fa\u7684\u53ef\u6267\u884c\u6587\u4ef6 (Executable and Linkable Format / ELF)\uff0c\u7279\u70b9\u662f\u672a\u538b\u7f29\u7684\uff0c\u5e26\u8c03\u8bd5\u4fe1\u606f\u548c\u7b26\u53f7\u8868\u7684\u3002\u5728\u6574\u5957 OS \u5b9e\u9a8c\u4e2d\uff0cvmlinux \u901a\u5e38\u6307\u5c06\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\uff0c\u94fe\u63a5\u540e\u751f\u6210\u7684\u53ef\u4f9b QEMU \u8fd0\u884c\u7684 RV64 \u67b6\u6784\u7a0b\u5e8f\u3002\u5982\u679c\u5bf9 vmlinux \u4f7f\u7528 file \u547d\u4ee4\uff0c\u4f60\u5c06\u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff1a 1 2 $ file vmlinux vmlinux: ELF 64 -bit LSB executable, UCB RISC-V, version 1 ( SYSV ) , statically linked, not stripped System.map System.map\u662f\u5185\u6838\u7b26\u53f7\u8868\uff08Kernel Symbol Table\uff09\u6587\u4ef6\uff0c\u662f\u5b58\u50a8\u4e86\u6240\u6709\u5185\u6838\u7b26\u53f7\u53ca\u5176\u5730\u5740\u7684\u4e00\u4e2a\u5217\u8868\u3002\u201c\u7b26\u53f7\u201d\u901a\u5e38\u6307\u7684\u662f\u51fd\u6570\u540d\uff0c\u5168\u5c40\u53d8\u91cf\u540d\u7b49\u7b49\u3002\u4f7f\u7528 nm vmlinux \u547d\u4ee4\u5373\u53ef\u6253\u5370vmlinux\u7684\u7b26\u53f7\u8868\uff0c\u7b26\u53f7\u8868\u7684\u6837\u4f8b\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 9 10 0000000000000800 A __vdso_rt_sigreturn ffffffe000000000 T __init_begin ffffffe000000000 T _sinittext ffffffe000000000 T _start ffffffe000000040 T _start_kernel ffffffe000000076 t clear_bss ffffffe000000080 t clear_bss_done ffffffe0000000c0 t relocate ffffffe00000017c t set_reset_devices ffffffe000000190 t debug_kernel \u4f7f\u7528 System.map \u53ef\u4ee5\u65b9\u4fbf\u5730\u8bfb\u51fa\u51fd\u6570\u6216\u53d8\u91cf\u7684\u5730\u5740\uff0c\u4e3a Debug \u63d0\u4f9b\u4e86\u65b9\u4fbf\u3002 4 \u5b9e\u9a8c\u6b65\u9aa4 4.1 \u51c6\u5907\u5de5\u7a0b \u4ece repo \u540c\u6b65\u5b9e\u9a8c\u4ee3\u7801\u6846\u67b6\uff0c \u53c2\u8003 Lab0 \u4e2d\uff0c\u5c06\u5de5\u7a0b\u4ee3\u7801\u6620\u5c04\u8fdb\u5bb9\u5668\u4e2d\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u65b9\u4fbf\u7684\u5728\u672c\u5730\u5f00\u53d1\uff0c\u540c\u65f6\u4f7f\u7528\u5bb9\u5668\u5185\u7684\u5de5\u5177\u8fdb\u884c\u7f16\u8bd1\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u251c\u2500\u2500 include \u2502 \u2502 \u251c\u2500\u2500 defs.h \u2502 \u2502 \u2514\u2500\u2500 sbi.h \u2502 \u251c\u2500\u2500 kernel \u2502 \u2502 \u251c\u2500\u2500 head.S \u2502 \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2502 \u251c\u2500\u2500 sbi.c \u2502 \u2502 \u2514\u2500\u2500 vmlinux.lds \u2502 \u2514\u2500\u2500 Makefile \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 print.h \u2502 \u2514\u2500\u2500 types.h \u251c\u2500\u2500 init \u2502 \u251c\u2500\u2500 main.c \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 test.c \u251c\u2500\u2500 lib \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 print.c \u2514\u2500\u2500 Makefile \u9700\u8981\u5b8c\u5584\u4ee5\u4e0b\u6587\u4ef6\uff1a arch/riscv/kernel/head.S lib/Makefile arch/riscv/kernel/sbi.c lib/print.c arch/riscv/include/defs.h 4.2 \u7f16\u5199head.S \u5b66\u4e60riscv\u7684\u6c47\u7f16\u3002 \u5b8c\u6210 arch/riscv/kernel/head.S \u3002\u6211\u4eec\u9996\u5148\u4e3a\u5373\u5c06\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u8bbe\u7f6e\u7a0b\u5e8f\u6808\uff08\u6808\u7684\u5927\u5c0f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a4KB\uff09\uff0c\u5e76\u5c06\u8be5\u6808\u653e\u7f6e\u5728 .bss.stack \u6bb5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u8df3\u8f6c\u6307\u4ee4\uff0c\u8df3\u8f6c\u81f3 main.c \u4e2d\u7684 start_kernel \u51fd\u6570\u5373\u53ef\u3002 4.3 \u5b8c\u5584 Makefile \u811a\u672c \u9605\u8bfb\u6587\u6863\u4e2d\u5173\u4e8e Makefile \u7684\u7ae0\u8282\uff0c\u4ee5\u53ca\u5de5\u7a0b\u6587\u4ef6\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c\u6839\u636e\u6ce8\u91ca\u5b66\u4f1a Makefile \u7684\u4f7f\u7528\u89c4\u5219\u540e\uff0c\u8865\u5145 lib/Makefile \uff0c\u4f7f\u5de5\u7a0b\u5f97\u4ee5\u7f16\u8bd1\u3002 \u5b8c\u6210\u6b64\u6b65\u540e\u5728\u5de5\u7a0b\u6839\u6587\u4ef6\u5939\u6267\u884c make\uff0c\u53ef\u4ee5\u770b\u5230\u5de5\u7a0b\u6210\u529f\u7f16\u8bd1\u51fa vmlinux\u3002 4.4 \u8865\u5145 sbi.c OpenSBI \u5728 M \u6001\uff0c\u4e3a S \u6001\u63d0\u4f9b\u4e86\u591a\u79cd\u63a5\u53e3\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u8f93\u5165\u8f93\u51fa\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u8c03\u7528 OpenSBI \u63a5\u53e3\u7684\u529f\u80fd\u3002\u7ed9\u51fa\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 struct sbiret { long error ; long value ; }; struct sbiret sbi_ecall ( int ext , int fid , uint64 arg0 , uint64 arg1 , uint64 arg2 , uint64 arg3 , uint64 arg4 , uint64 arg5 ); sbi_ecall \u51fd\u6570\u4e2d\uff0c\u9700\u8981\u5b8c\u6210\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5c06 ext (Extension ID) \u653e\u5165\u5bc4\u5b58\u5668 a7 \u4e2d\uff0cfid (Function ID) \u653e\u5165\u5bc4\u5b58\u5668 a6 \u4e2d\uff0c\u5c06 arg0 ~ arg5 \u653e\u5165\u5bc4\u5b58\u5668 a0 ~ a5 \u4e2d\u3002 \u4f7f\u7528 ecall \u6307\u4ee4\u3002 ecall \u4e4b\u540e\u7cfb\u7edf\u4f1a\u8fdb\u5165 M \u6a21\u5f0f\uff0c\u4e4b\u540e OpenSBI \u4f1a\u5b8c\u6210\u76f8\u5173\u64cd\u4f5c\u3002 OpenSBI \u7684\u8fd4\u56de\u7ed3\u679c\u4f1a\u5b58\u653e\u5728\u5bc4\u5b58\u5668 a0 \uff0c a1 \u4e2d\uff0c\u5176\u4e2d a0 \u4e3a error code\uff0c a1 \u4e3a\u8fd4\u56de\u503c\uff0c \u6211\u4eec\u7528 sbiret \u6765\u63a5\u53d7\u8fd9\u4e24\u4e2a\u8fd4\u56de\u503c\u3002 \u540c\u5b66\u4eec\u53ef\u4ee5\u53c2\u7167\u5185\u8054\u6c47\u7f16\u7684\u793a\u4f8b\u4e00\u5b8c\u6210\u8be5\u51fd\u6570\u7684\u7f16\u5199\u3002 \u7f16\u5199\u6210\u529f\u540e\uff0c\u8c03\u7528 sbi_ecall(0x1, 0x0, 0x30, 0, 0, 0, 0, 0) \u5c06\u4f1a\u8f93\u51fa\u5b57\u7b26'0'\u3002\u5176\u4e2d 0x1 \u4ee3\u8868 sbi_console_putchar \u7684 ExtensionID\uff0c 0x0 \u4ee3\u8868FunctionID, 0x30\u4ee3\u8868'0'\u7684ascii\u503c\uff0c\u5176\u4f59\u53c2\u6570\u586b0\u3002 \u8bf7\u5728 arch/riscv/kernel/sbi.c \u4e2d\u8865\u5145 sbi_ecall() \u3002 \u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5728\u540e\u7eed\u7684\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684\u529f\u80fd\u3002 Function Name Function ID Extension ID sbi_set_timer \uff08\u8bbe\u7f6e\u65f6\u949f\u76f8\u5173\u5bc4\u5b58\u5668\uff09 0 0x00 sbi_console_putchar \uff08\u6253\u5370\u5b57\u7b26\uff09 0 0x01 sbi_console_getchar \uff08\u63a5\u6536\u5b57\u7b26\uff09 0 0x02 sbi_shutdown \uff08\u5173\u673a\uff09 0 0x08 4.5 puts() \u548c puti() \u8c03\u7528\u4ee5\u4e0a\u5b8c\u6210\u7684 sbi_ecall , \u5b8c\u6210 puts() \u548c puti() \u7684\u5b9e\u73b0\u3002 puts() \u7528\u4e8e\u6253\u5370\u5b57\u7b26\u4e32\uff0c puti() \u7528\u4e8e\u6253\u5370\u6574\u578b\u53d8\u91cf\u3002 \u8bf7\u7f16\u5199 lib/print.c \u4e2d\u7684 puts() \u548c puti() \uff0c \u51fd\u6570\u7684\u76f8\u5173\u5b9a\u4e49\u5df2\u7ecf\u5199\u5728\u4e86 print.h \u6587\u4ef6\u3002 4.6 \u4fee\u6539 defs \u5185\u8054\u6c47\u7f16\u7684\u76f8\u5173\u77e5\u8bc6\u89c1 \u5185\u8054\u6c47\u7f16 \u3002 \u5b66\u4e60\u4e86\u89e3\u4e86\u4ee5\u4e0a\u77e5\u8bc6\u540e\uff0c\u8865\u5145 arch/riscv/include/defs.h \u4e2d\u7684\u4ee3\u7801\u5b8c\u6210\uff1a \u8865\u5145\u5b8c read_csr \u8fd9\u4e2a\u5b8f\u5b9a\u4e49\u3002\u8fd9\u91cc\u6709\u76f8\u5173 \u793a\u4f8b \u3002 \u601d\u8003\u9898 \u8bf7\u603b\u7ed3\u4e00\u4e0b RISC-V \u7684 calling convention\uff0c\u5e76\u89e3\u91ca Caller / Callee Saved Register \u6709\u4ec0\u4e48\u533a\u522b\uff1f \u7f16\u8bd1\u4e4b\u540e\uff0c\u901a\u8fc7 System.map \u67e5\u770b vmlinux.lds \u4e2d\u81ea\u5b9a\u4e49\u7b26\u53f7\u7684\u503c \u4f5c\u4e1a\u63d0\u4ea4 \u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u5b9e\u9a8c\u6307\u5bfc\u4e00"},{"location":"lab1/#lab-1-rv64","text":"","title":"Lab 1: RV64 \u5185\u6838\u5f15\u5bfc"},{"location":"lab1/#1","text":"\u5b66\u4e60 RISC-V \u6c47\u7f16\uff0c \u7f16\u5199 head.S \u5b9e\u73b0\u8df3\u8f6c\u5230\u5185\u6838\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u3002 \u5b66\u4e60 OpenSBI\uff0c\u7406\u89e3 OpenSBI \u5728\u5b9e\u9a8c\u4e2d\u6240\u8d77\u5230\u7684\u4f5c\u7528\uff0c\u5e76\u8c03\u7528 OpenSBI \u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u5b57\u7b26\u7684\u8f93\u51fa\u3002 \u5b66\u4e60 Makefile \u76f8\u5173\u77e5\u8bc6\uff0c \u8865\u5145\u9879\u76ee\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c \u6765\u5b8c\u6210\u5bf9\u6574\u4e2a\u5de5\u7a0b\u7684\u7ba1\u7406\u3002","title":"1 \u5b9e\u9a8c\u76ee\u7684"},{"location":"lab1/#2","text":"Environment in Lab0","title":"2 \u5b9e\u9a8c\u73af\u5883"},{"location":"lab1/#3","text":"","title":"3 \u5b9e\u9a8c\u57fa\u7840\u77e5\u8bc6\u4ecb\u7ecd"},{"location":"lab1/#31","text":"\u4e3a\u4e86\u987a\u5229\u5b8c\u6210 OS \u5b9e\u9a8c\uff0c\u6211\u4eec\u9700\u8981\u4e00\u4e9b\u524d\u7f6e\u77e5\u8bc6\u548c\u8f83\u591a\u8c03\u8bd5\u6280\u5de7\u3002\u5728 OS \u5b9e\u9a8c\u4e2d\u6211\u4eec\u9700\u8981 RISC-V\u6c47\u7f16 \u7684\u524d\u7f6e\u77e5\u8bc6\uff0c\u8bfe\u5802\u4e0a\u4e0d\u4f1a\u8bb2\u6388\uff0c\u8bf7\u540c\u5b66\u4eec\u901a\u8fc7\u9605\u8bfb\u4ee5\u4e0b\u56db\u4efd\u6587\u6863\u81ea\u5b66\uff1a RISC-V Assembly Programmer's Manual RISC-V Unprivileged Spec RISC-V Privileged Spec RISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09 \u6ce8\uff1aRISC-V \u624b\u518c\uff08\u4e2d\u6587\uff09\u4e2d\u6709\u4e00\u4e9b Typo\uff0c\u8bf7\u8c28\u614e\u53c2\u8003\u3002","title":"3.1 \u524d\u7f6e\u77e5\u8bc6"},{"location":"lab1/#32-risc-v","text":"RISC-V \u6709\u4e09\u4e2a\u7279\u6743\u6a21\u5f0f\uff1aU (user) \u6a21\u5f0f\u3001S (supervisor) \u6a21\u5f0f\u548c M (machine) \u6a21\u5f0f\u3002 Level Encoding Name Abbreviation 0 00 User/Application U 1 01 Supervisor S 2 10 Reserved 3 11 Machine M \u5176\u4e2d\uff1a M \u6a21\u5f0f\u662f\u5bf9\u786c\u4ef6\u64cd\u4f5c\u7684\u62bd\u8c61\uff0c\u6709 \u6700\u9ad8 \u7ea7\u522b\u7684\u6743\u9650 S \u6a21\u5f0f\u4ecb\u4e8e M \u6a21\u5f0f\u548c U \u6a21\u5f0f\u4e4b\u95f4\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u5185\u6838\u6001 (Kernel)\u3002\u5f53\u7528\u6237\u9700\u8981\u5185\u6838\u8d44\u6e90\u65f6\uff0c\u5411\u5185\u6838\u7533\u8bf7\uff0c\u5e76\u5207\u6362\u5230\u5185\u6838\u6001\u8fdb\u884c\u5904\u7406 U \u6a21\u5f0f\u7528\u4e8e\u6267\u884c\u7528\u6237\u7a0b\u5e8f\uff0c\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5bf9\u5e94\u4e8e\u7528\u6237\u6001\uff0c\u6709 \u6700\u4f4e \u7ea7\u522b\u7684\u6743\u9650","title":"3.2 RISC-V \u7684\u4e09\u79cd\u7279\u6743\u6a21\u5f0f"},{"location":"lab1/#33-os","text":"\u6211\u4eec\u4ee5\u6700\u57fa\u7840\u7684\u5d4c\u5165\u5f0f\u7cfb\u7edf\u4e3a\u4f8b\uff0c\u8ba1\u7b97\u673a\u4e0a\u7535\u540e\uff0c\u9996\u5148\u786c\u4ef6\u8fdb\u884c\u4e00\u4e9b\u57fa\u7840\u7684\u521d\u59cb\u5316\u540e\uff0c\u5c06 CPU \u7684 Program Counter \u79fb\u52a8\u5230\u5185\u5b58\u4e2d Bootloader \u7684\u8d77\u59cb\u5730\u5740\u3002 Bootloader \u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd0\u884c\u4e4b\u524d\uff0c\u7528\u4e8e\u521d\u59cb\u5316\u786c\u4ef6\uff0c\u52a0\u8f7d\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u3002 \u5728 RISC-V \u67b6\u6784\u91cc\uff0cBootloader \u8fd0\u884c\u5728 M \u6a21\u5f0f\u4e0b\u3002Bootloader \u8fd0\u884c\u5b8c\u6bd5\u540e\u5c31\u4f1a\u628a\u5f53\u524d\u6a21\u5f0f\u5207\u6362\u5230 S \u6a21\u5f0f\u4e0b\uff0c\u673a\u5668\u968f\u540e\u5f00\u59cb\u8fd0\u884c Kernel\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u7b80\u5355\u800c\u8a00\u5c31\u662f\u8fd9\u6837\uff1a 1 2 3 4 Hardware RISC-V M Mode RISC-V S Mode +------------+ +--------------+ +----------+ | Power On | ----> | Bootloader | ----> | Kernel | +------------+ +--------------+ +----------+","title":"3.3 \u4ece\u8ba1\u7b97\u673a\u4e0a\u7535\u5230 OS \u8fd0\u884c"},{"location":"lab1/#34-sbi-opensbi","text":"SBI (Supervisor Binary Interface) \u662f S-mode \u7684 Kernel \u548c M-mode \u6267\u884c\u73af\u5883\u4e4b\u95f4\u7684\u63a5\u53e3\u89c4\u8303\uff0c\u800c OpenSBI \u662f\u4e00\u4e2a RISC-V SBI \u89c4\u8303\u7684\u5f00\u6e90\u5b9e\u73b0\u3002RISC-V \u5e73\u53f0\u548c SoC \u4f9b\u5e94\u5546\u53ef\u4ee5\u81ea\u4e3b\u6269\u5c55 OpenSBI \u5b9e\u73b0\uff0c\u4ee5\u9002\u5e94\u7279\u5b9a\u7684\u786c\u4ef6\u914d\u7f6e\u3002 \u7b80\u5355\u7684\u8bf4\uff0c\u4e3a\u4e86\u4f7f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u9002\u914d\u4e0d\u540c\u786c\u4ef6\uff0cOpenSBI \u63d0\u51fa\u4e86\u4e00\u7cfb\u5217\u89c4\u8303\u5bf9 M-mode \u4e0b\u7684\u786c\u4ef6\u8fdb\u884c\u4e86\u7edf\u4e00\u5b9a\u4e49\uff0c\u8fd0\u884c\u5728 S-mode \u4e0b\u7684\u5185\u6838\u53ef\u4ee5\u6309\u7167\u8fd9\u4e9b\u89c4\u8303\u5bf9\u4e0d\u540c\u786c\u4ef6\u8fdb\u884c\u64cd\u4f5c\u3002 \u4e3a\u964d\u4f4e\u5b9e\u9a8c\u96be\u5ea6\uff0c\u6211\u4eec\u9009\u62e9 OpenSBI \u4f5c\u4e3a Bootloader \u6765\u5b8c\u6210\u673a\u5668\u542f\u52a8\u65f6 M-mode \u4e0b\u7684\u786c\u4ef6\u521d\u59cb\u5316\u4e0e\u5bc4\u5b58\u5668\u8bbe\u7f6e\uff0c\u5e76\u4f7f\u7528 OpenSBI \u6240\u63d0\u4f9b\u7684\u63a5\u53e3\u5b8c\u6210\u8bf8\u5982\u5b57\u7b26\u6253\u5370\u7684\u64cd\u4f5c\u3002 \u5728\u5b9e\u9a8c\u4e2d\uff0cQEMU \u5df2\u7ecf\u5185\u7f6e\u4e86 OpenSBI \u4f5c\u4e3a Bootloader\uff0c\u6211\u4eec\u53ef\u4ee5\u4f7f\u7528 -bios default \u542f\u7528\u3002\u5982\u679c\u542f\u7528\uff0cQEMU \u4f1a\u5c06 OpenSBI \u4ee3\u7801\u52a0\u8f7d\u5230 0x80000000 \u8d77\u59cb\u5904\u3002OpenSBI \u521d\u59cb\u5316\u5b8c\u6210\u540e\uff0c\u4f1a\u8df3\u8f6c\u5230 0x80200000 \u5904\uff08\u4e5f\u5c31\u662f Kernel \u7684\u8d77\u59cb\u5730\u5740\uff09\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6240\u7f16\u8bd1\u7684\u4ee3\u7801\u9700\u8981\u653e\u5230 0x80200000 \u5904\u3002 \u5982\u679c\u4f60\u5bf9 RISC-V \u67b6\u6784\u7684 Boot \u6d41\u7a0b\u6709\u66f4\u591a\u7684\u597d\u5947\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u4efd bootflow \u3002","title":"3.4 SBI \u4e0e OpenSBI"},{"location":"lab1/#35-makefile","text":"Makefile \u53ef\u4ee5\u7b80\u5355\u7684\u8ba4\u4e3a\u662f\u4e00\u4e2a\u5de5\u7a0b\u6587\u4ef6\u7684\u7f16\u8bd1\u89c4\u5219\uff0c\u63cf\u8ff0\u4e86\u6574\u4e2a\u5de5\u7a0b\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\u6d41\u7a0b\u3002\u5728 Lab0 \u4e2d\u6211\u4eec\u5df2\u7ecf\u4f7f\u7528\u4e86 make \u5de5\u5177\u5229\u7528 Makefile \u6587\u4ef6\u6765\u7ba1\u7406\u6574\u4e2a\u5de5\u7a0b\u3002\u5728\u9605\u8bfb\u4e86 Makefile\u4ecb\u7ecd \u8fd9\u4e00\u7ae0\u8282\u540e\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u6839\u636e\u5de5\u7a0b\u6587\u4ef6\u5939\u91cc Makefile \u7684\u4ee3\u7801\u6765\u638c\u63e1\u4e00\u4e9b\u57fa\u672c\u7684\u4f7f\u7528\u6280\u5de7\u3002","title":"3.5 Makefile"},{"location":"lab1/#36","text":"\u5185\u8054\u6c47\u7f16\uff08\u901a\u5e38\u7531 asm \u6216\u8005 __asm__ \u5173\u952e\u5b57\u5f15\u5165\uff09\u63d0\u4f9b\u4e86\u5c06\u6c47\u7f16\u8bed\u8a00\u6e90\u4ee3\u7801\u5d4c\u5165 C \u7a0b\u5e8f\u7684\u80fd\u529b\u3002 \u5185\u8054\u6c47\u7f16\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Assembler Instructions with C Expression Operands \u3002 \u4e0b\u9762\u7b80\u8981\u4ecb\u7ecd\u4e00\u4e0b\u8fd9\u6b21\u5b9e\u9a8c\u4f1a\u7528\u5230\u7684\u4e00\u4e9b\u5185\u8054\u6c47\u7f16\u77e5\u8bc6\uff1a \u5185\u8054\u6c47\u7f16\u57fa\u672c\u683c\u5f0f\u4e3a\uff1a 1 2 3 4 5 6 7 8 9 10 __asm__ volatile ( \"instruction1 \\n \" \"instruction2 \\n \" ...... ...... \"instruction3 \\n \" : [ out1 ] \"=r\" ( v1 ),[ out2 ] \"=r\" ( v2 ) : [ in1 ] \"r\" ( v1 ), [ in2 ] \"r\" ( v2 ) : \"memory\" ); \u5176\u4e2d\uff0c\u4e09\u4e2a : \u5c06\u6c47\u7f16\u90e8\u5206\u5206\u6210\u4e86\u56db\u90e8\u5206\uff1a \u7b2c\u4e00\u90e8\u5206\u662f\u6c47\u7f16\u6307\u4ee4\uff0c\u6307\u4ee4\u672b\u5c3e\u9700\u8981\u6dfb\u52a0 '\\n'\u3002 \u7b2c\u4e8c\u90e8\u5206\u662f\u8f93\u51fa\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u4e09\u90e8\u5206\u662f\u8f93\u5165\u64cd\u4f5c\u6570\u90e8\u5206\u3002 \u7b2c\u56db\u90e8\u5206\u662f\u53ef\u80fd\u5f71\u54cd\u7684\u5bc4\u5b58\u5668\u6216\u5b58\u50a8\u5668\uff0c\u7528\u4e8e\u544a\u77e5\u7f16\u8bd1\u5668\u5f53\u524d\u5185\u8054\u6c47\u7f16\u8bed\u53e5\u53ef\u80fd\u4f1a\u5bf9\u67d0\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\u8fdb\u884c\u4fee\u6539\uff0c\u4f7f\u5f97\u7f16\u8bd1\u5668\u5728\u4f18\u5316\u65f6\u5c06\u5176\u56e0\u7d20\u8003\u8651\u8fdb\u53bb\u3002 \u8fd9\u56db\u90e8\u5206\u4e2d\u540e\u4e09\u90e8\u5206\u4e0d\u662f\u5fc5\u987b\u7684\u3002","title":"3.6 \u5185\u8054\u6c47\u7f16"},{"location":"lab1/#_1","text":"1 2 3 4 5 6 7 8 9 10 11 12 unsigned long long s_example ( unsigned long long type , unsigned long long arg0 ) { unsigned long long ret_val ; __asm__ volatile ( \"mv x10, %[type] \\n \" \"mv x11, %[arg0] \\n \" \"mv %[ret_val], x12\" : [ ret_val ] \"=r\" ( ret_val ) : [ type ] \"r\" ( type ), [ arg0 ] \"r\" ( arg0 ) : \"memory\" ); return ret_val ; } \u793a\u4f8b\u4e00\u4e2d\u6307\u4ee4\u90e8\u5206\uff0c %[type] \u3001 %[arg0] \u4ee5\u53ca %[ret_val] \u4ee3\u8868\u7740\u7279\u5b9a\u7684\u5bc4\u5b58\u5668\u6216\u662f\u5185\u5b58\u3002 \u8f93\u5165\u8f93\u51fa\u90e8\u5206\u4e2d\uff0c [type] \"r\" (type) \u4ee3\u8868\u7740\u5c06 () \u4e2d\u7684\u53d8\u91cf type \u653e\u5165\u5bc4\u5b58\u5668\u4e2d\uff08 \"r\" \u6307\u653e\u5165\u5bc4\u5b58\u5668\uff0c\u5982\u679c\u662f \"m\" \u5219\u4e3a\u653e\u5165\u5185\u5b58\uff09\uff0c\u5e76\u4e14\u7ed1\u5b9a\u5230 [] \u4e2d\u547d\u540d\u7684\u7b26\u53f7\u4e2d\u53bb\u3002 [ret_val] \"=r\" (ret_val) \u4ee3\u8868\u7740\u5c06\u6c47\u7f16\u6307\u4ee4\u4e2d %[ret_val] \u7684\u503c\u66f4\u65b0\u5230\u53d8\u91cf ret_val \u4e2d\u3002","title":"\u793a\u4f8b\u4e00"},{"location":"lab1/#_2","text":"1 2 #define write_csr(reg, val) ({ __asm__ volatile ( \"csrw \" # reg \", %0\" :: \"r\" ( val )); }) \u793a\u4f8b\u4e8c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5b8f\uff0c\u5176\u4e2d %0 \u4ee3\u8868\u7740\u8f93\u51fa\u8f93\u5165\u90e8\u5206\u7684\u7b2c\u4e00\u4e2a\u7b26\u53f7\uff0c\u5373 val \u3002 #reg \u662fc\u8bed\u8a00\u7684\u4e00\u4e2a\u7279\u6b8a\u5b8f\u5b9a\u4e49\u8bed\u6cd5\uff0c\u76f8\u5f53\u4e8e\u5c06reg\u8fdb\u884c\u5b8f\u66ff\u6362\u5e76\u7528\u53cc\u5f15\u53f7\u5305\u88f9\u8d77\u6765\u3002 \u4f8b\u5982 write_csr(sstatus,val) \u7ecf\u5b8f\u5c55\u5f00\u4f1a\u5f97\u5230\uff1a 1 2 ({ __asm__ volatile ( \"csrw \" \"sstatus\" \", %0\" :: \"r\" ( val )); })","title":"\u793a\u4f8b\u4e8c"},{"location":"lab1/#37","text":"","title":"3.7 \u7f16\u8bd1\u76f8\u5173\u77e5\u8bc6\u4ecb\u7ecd"},{"location":"lab1/#vmlinuxlds","text":"GNU ld \u5373\u94fe\u63a5\u5668\uff0c\u7528\u4e8e\u5c06 *.o \u6587\u4ef6\uff08\u548c\u5e93\u6587\u4ef6\uff09\u94fe\u63a5\u6210\u53ef\u6267\u884c\u6587\u4ef6\u3002\u5728\u64cd\u4f5c\u7cfb\u7edf\u5f00\u53d1\u4e2d\uff0c\u4e3a\u4e86\u6307\u5b9a\u7a0b\u5e8f\u7684\u5185\u5b58\u5e03\u5c40\uff0cld \u4f7f\u7528\u94fe\u63a5\u811a\u672c\uff08Linker Script\uff09\u6765\u63a7\u5236\uff0c\u5728 Linux Kernel \u4e2d\u94fe\u63a5\u811a\u672c\u88ab\u547d\u540d\u4e3a vmlinux.lds\u3002\u66f4\u591a\u5173\u4e8e ld \u7684\u4ecb\u7ecd\u53ef\u4ee5\u4f7f\u7528 man ld \u547d\u4ee4\u3002 \u4e0b\u9762\u7ed9\u51fa\u4e00\u4e2a vmlinux.lds \u7684\u4f8b\u5b50\uff1a 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 /* \u76ee\u6807\u67b6\u6784 */ OUTPUT_ARCH( \"riscv\" ) /* \u7a0b\u5e8f\u5165\u53e3 */ ENTRY( _start ) /* kernel\u4ee3\u7801\u8d77\u59cb\u4f4d\u7f6e */ BASE_ADDR = 0x80200000; SECTIONS { /* . \u4ee3\u8868\u5f53\u524d\u5730\u5740 */ . = BASE_ADDR; /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u8d77\u59cb\u5730\u5740 */ _skernel = .; /* ALIGN(0x1000) \u8868\u793a4KB\u5bf9\u9f50 */ /* _stext, _etext \u5206\u522b\u8bb0\u5f55\u4e86text\u6bb5\u7684\u8d77\u59cb\u4e0e\u7ed3\u675f\u5730\u5740 */ .text : ALIGN(0x1000){ _stext = .; *(.text.entry) *(.text .text.*) _etext = .; } .rodata : ALIGN(0x1000){ _srodata = .; *(.rodata .rodata.*) _erodata = .; } .data : ALIGN(0x1000){ _sdata = .; *(.data .data.*) _edata = .; } .bss : ALIGN(0x1000){ _sbss = .; *(.bss.stack) sbss = .; *(.bss .bss.*) _ebss = .; } /* \u8bb0\u5f55kernel\u4ee3\u7801\u7684\u7ed3\u675f\u5730\u5740 */ _ekernel = .; } \u9996\u5148\u6211\u4eec\u4f7f\u7528 OUTPUT_ARCH \u6307\u5b9a\u4e86\u67b6\u6784\u4e3a RISC-V \uff0c\u4e4b\u540e\u4f7f\u7528 ENTRY \u6307\u5b9a\u7a0b\u5e8f\u5165\u53e3\u70b9\u4e3a _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u5165\u53e3\u70b9\u5373\u7a0b\u5e8f\u542f\u52a8\u65f6\u8fd0\u884c\u7684\u51fd\u6570\uff0c\u7ecf\u8fc7\u8fd9\u6837\u7684\u6307\u5b9a\u540e\u5728head.S\u4e2d\u9700\u8981\u7f16\u5199 _start \u51fd\u6570\uff0c\u7a0b\u5e8f\u624d\u80fd\u6b63\u5e38\u8fd0\u884c\u3002 \u94fe\u63a5\u811a\u672c\u4e2d\u6709 . * \u4e24\u4e2a\u91cd\u8981\u7684\u7b26\u53f7\u3002\u5355\u72ec\u7684 . \u5728\u94fe\u63a5\u811a\u672c\u4ee3\u8868\u5f53\u524d\u5730\u5740\uff0c\u5b83\u6709\u8d4b\u503c\u3001\u88ab\u8d4b\u503c\u3001\u81ea\u589e\u7b49\u64cd\u4f5c\u3002\u800c * \u6709\u4e24\u79cd\u7528\u6cd5\uff0c\u5176\u4e00\u662f *() \u5728\u5927\u62ec\u53f7\u4e2d\u8868\u793a\u5c06\u6240\u6709\u6587\u4ef6\u4e2d\u7b26\u5408\u62ec\u53f7\u5185\u8981\u6c42\u7684\u6bb5\u653e\u7f6e\u5728\u5f53\u524d\u4f4d\u7f6e\uff0c\u5176\u4e8c\u662f\u4f5c\u4e3a\u901a\u914d\u7b26\u3002 \u94fe\u63a5\u811a\u672c\u7684\u4e3b\u4f53\u662fSECTIONS\u90e8\u5206\uff0c\u5728\u8fd9\u91cc\u94fe\u63a5\u811a\u672c\u7684\u5de5\u4f5c\u662f\u5c06\u7a0b\u5e8f\u7684\u5404\u4e2a\u6bb5\u6309\u987a\u5e8f\u653e\u5728\u5404\u4e2a\u5730\u5740\u4e0a\uff0c\u5728\u4f8b\u5b50\u4e2d\u5c31\u662f\u4ece0x80200000\u5730\u5740\u5f00\u59cb\u653e\u7f6e\u4e86 .text \uff0c .rodata \uff0c .data \u548c .bss \u6bb5\u3002\u5404\u4e2a\u6bb5\u7684\u4f5c\u7528\u53ef\u4ee5\u7b80\u8981\u6982\u62ec\u6210\uff1a \u6bb5\u540d \u4e3b\u8981\u4f5c\u7528 .text \u901a\u5e38\u5b58\u653e\u7a0b\u5e8f\u6267\u884c\u4ee3\u7801 .rodata \u901a\u5e38\u5b58\u653e\u5e38\u91cf\u7b49\u53ea\u8bfb\u6570\u636e .data \u901a\u5e38\u5b58\u653e\u5df2\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf .bss \u901a\u5e38\u5b58\u653e\u672a\u521d\u59cb\u5316\u7684\u5168\u5c40\u53d8\u91cf\u3001\u9759\u6001\u53d8\u91cf \u5728\u94fe\u63a5\u811a\u672c\u4e2d\u53ef\u4ee5\u81ea\u5b9a\u4e49\u7b26\u53f7\uff0c\u4f8b\u5982\u4ee5\u4e0a\u6240\u6709 _s \u4e0e _e \u5f00\u5934\u7684\u7b26\u53f7\u90fd\u662f\u6211\u4eec\u81ea\u5df1\u5b9a\u4e49\u7684\u3002 \u66f4\u591a\u6709\u5173\u94fe\u63a5\u811a\u672c\u8bed\u6cd5\u53ef\u4ee5\u53c2\u8003 \u8fd9\u91cc \u3002","title":"vmlinux.lds"},{"location":"lab1/#vmlinux","text":"vmlinux \u901a\u5e38\u6307 Linux Kernel \u7f16\u8bd1\u51fa\u7684\u53ef\u6267\u884c\u6587\u4ef6 (Executable and Linkable Format / ELF)\uff0c\u7279\u70b9\u662f\u672a\u538b\u7f29\u7684\uff0c\u5e26\u8c03\u8bd5\u4fe1\u606f\u548c\u7b26\u53f7\u8868\u7684\u3002\u5728\u6574\u5957 OS \u5b9e\u9a8c\u4e2d\uff0cvmlinux \u901a\u5e38\u6307\u5c06\u4f60\u7684\u4ee3\u7801\u8fdb\u884c\u7f16\u8bd1\uff0c\u94fe\u63a5\u540e\u751f\u6210\u7684\u53ef\u4f9b QEMU \u8fd0\u884c\u7684 RV64 \u67b6\u6784\u7a0b\u5e8f\u3002\u5982\u679c\u5bf9 vmlinux \u4f7f\u7528 file \u547d\u4ee4\uff0c\u4f60\u5c06\u770b\u5230\u5982\u4e0b\u4fe1\u606f\uff1a 1 2 $ file vmlinux vmlinux: ELF 64 -bit LSB executable, UCB RISC-V, version 1 ( SYSV ) , statically linked, not stripped","title":"vmlinux"},{"location":"lab1/#systemmap","text":"System.map\u662f\u5185\u6838\u7b26\u53f7\u8868\uff08Kernel Symbol Table\uff09\u6587\u4ef6\uff0c\u662f\u5b58\u50a8\u4e86\u6240\u6709\u5185\u6838\u7b26\u53f7\u53ca\u5176\u5730\u5740\u7684\u4e00\u4e2a\u5217\u8868\u3002\u201c\u7b26\u53f7\u201d\u901a\u5e38\u6307\u7684\u662f\u51fd\u6570\u540d\uff0c\u5168\u5c40\u53d8\u91cf\u540d\u7b49\u7b49\u3002\u4f7f\u7528 nm vmlinux \u547d\u4ee4\u5373\u53ef\u6253\u5370vmlinux\u7684\u7b26\u53f7\u8868\uff0c\u7b26\u53f7\u8868\u7684\u6837\u4f8b\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 9 10 0000000000000800 A __vdso_rt_sigreturn ffffffe000000000 T __init_begin ffffffe000000000 T _sinittext ffffffe000000000 T _start ffffffe000000040 T _start_kernel ffffffe000000076 t clear_bss ffffffe000000080 t clear_bss_done ffffffe0000000c0 t relocate ffffffe00000017c t set_reset_devices ffffffe000000190 t debug_kernel \u4f7f\u7528 System.map \u53ef\u4ee5\u65b9\u4fbf\u5730\u8bfb\u51fa\u51fd\u6570\u6216\u53d8\u91cf\u7684\u5730\u5740\uff0c\u4e3a Debug \u63d0\u4f9b\u4e86\u65b9\u4fbf\u3002","title":"System.map"},{"location":"lab1/#4","text":"","title":"4 \u5b9e\u9a8c\u6b65\u9aa4"},{"location":"lab1/#41","text":"\u4ece repo \u540c\u6b65\u5b9e\u9a8c\u4ee3\u7801\u6846\u67b6\uff0c \u53c2\u8003 Lab0 \u4e2d\uff0c\u5c06\u5de5\u7a0b\u4ee3\u7801\u6620\u5c04\u8fdb\u5bb9\u5668\u4e2d\u3002\u8fd9\u6837\u5c31\u53ef\u4ee5\u65b9\u4fbf\u7684\u5728\u672c\u5730\u5f00\u53d1\uff0c\u540c\u65f6\u4f7f\u7528\u5bb9\u5668\u5185\u7684\u5de5\u5177\u8fdb\u884c\u7f16\u8bd1\u3002 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 \u251c\u2500\u2500 arch \u2502 \u2514\u2500\u2500 riscv \u2502 \u251c\u2500\u2500 include \u2502 \u2502 \u251c\u2500\u2500 defs.h \u2502 \u2502 \u2514\u2500\u2500 sbi.h \u2502 \u251c\u2500\u2500 kernel \u2502 \u2502 \u251c\u2500\u2500 head.S \u2502 \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2502 \u251c\u2500\u2500 sbi.c \u2502 \u2502 \u2514\u2500\u2500 vmlinux.lds \u2502 \u2514\u2500\u2500 Makefile \u251c\u2500\u2500 include \u2502 \u251c\u2500\u2500 print.h \u2502 \u2514\u2500\u2500 types.h \u251c\u2500\u2500 init \u2502 \u251c\u2500\u2500 main.c \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 test.c \u251c\u2500\u2500 lib \u2502 \u251c\u2500\u2500 Makefile \u2502 \u2514\u2500\u2500 print.c \u2514\u2500\u2500 Makefile \u9700\u8981\u5b8c\u5584\u4ee5\u4e0b\u6587\u4ef6\uff1a arch/riscv/kernel/head.S lib/Makefile arch/riscv/kernel/sbi.c lib/print.c arch/riscv/include/defs.h","title":"4.1 \u51c6\u5907\u5de5\u7a0b"},{"location":"lab1/#42-heads","text":"\u5b66\u4e60riscv\u7684\u6c47\u7f16\u3002 \u5b8c\u6210 arch/riscv/kernel/head.S \u3002\u6211\u4eec\u9996\u5148\u4e3a\u5373\u5c06\u8fd0\u884c\u7684\u7b2c\u4e00\u4e2a C \u51fd\u6570\u8bbe\u7f6e\u7a0b\u5e8f\u6808\uff08\u6808\u7684\u5927\u5c0f\u53ef\u4ee5\u8bbe\u7f6e\u4e3a4KB\uff09\uff0c\u5e76\u5c06\u8be5\u6808\u653e\u7f6e\u5728 .bss.stack \u6bb5\u3002\u63a5\u4e0b\u6765\u6211\u4eec\u53ea\u9700\u8981\u901a\u8fc7\u8df3\u8f6c\u6307\u4ee4\uff0c\u8df3\u8f6c\u81f3 main.c \u4e2d\u7684 start_kernel \u51fd\u6570\u5373\u53ef\u3002","title":"4.2 \u7f16\u5199head.S"},{"location":"lab1/#43-makefile","text":"\u9605\u8bfb\u6587\u6863\u4e2d\u5173\u4e8e Makefile \u7684\u7ae0\u8282\uff0c\u4ee5\u53ca\u5de5\u7a0b\u6587\u4ef6\u4e2d\u7684 Makefile \u6587\u4ef6\uff0c\u6839\u636e\u6ce8\u91ca\u5b66\u4f1a Makefile \u7684\u4f7f\u7528\u89c4\u5219\u540e\uff0c\u8865\u5145 lib/Makefile \uff0c\u4f7f\u5de5\u7a0b\u5f97\u4ee5\u7f16\u8bd1\u3002 \u5b8c\u6210\u6b64\u6b65\u540e\u5728\u5de5\u7a0b\u6839\u6587\u4ef6\u5939\u6267\u884c make\uff0c\u53ef\u4ee5\u770b\u5230\u5de5\u7a0b\u6210\u529f\u7f16\u8bd1\u51fa vmlinux\u3002","title":"4.3 \u5b8c\u5584 Makefile \u811a\u672c"},{"location":"lab1/#44-sbic","text":"OpenSBI \u5728 M \u6001\uff0c\u4e3a S \u6001\u63d0\u4f9b\u4e86\u591a\u79cd\u63a5\u53e3\uff0c\u6bd4\u5982\u5b57\u7b26\u4e32\u8f93\u5165\u8f93\u51fa\u3002\u56e0\u6b64\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u8c03\u7528 OpenSBI \u63a5\u53e3\u7684\u529f\u80fd\u3002\u7ed9\u51fa\u51fd\u6570\u5b9a\u4e49\u5982\u4e0b\uff1a 1 2 3 4 5 6 7 8 struct sbiret { long error ; long value ; }; struct sbiret sbi_ecall ( int ext , int fid , uint64 arg0 , uint64 arg1 , uint64 arg2 , uint64 arg3 , uint64 arg4 , uint64 arg5 ); sbi_ecall \u51fd\u6570\u4e2d\uff0c\u9700\u8981\u5b8c\u6210\u4ee5\u4e0b\u5185\u5bb9\uff1a \u5c06 ext (Extension ID) \u653e\u5165\u5bc4\u5b58\u5668 a7 \u4e2d\uff0cfid (Function ID) \u653e\u5165\u5bc4\u5b58\u5668 a6 \u4e2d\uff0c\u5c06 arg0 ~ arg5 \u653e\u5165\u5bc4\u5b58\u5668 a0 ~ a5 \u4e2d\u3002 \u4f7f\u7528 ecall \u6307\u4ee4\u3002 ecall \u4e4b\u540e\u7cfb\u7edf\u4f1a\u8fdb\u5165 M \u6a21\u5f0f\uff0c\u4e4b\u540e OpenSBI \u4f1a\u5b8c\u6210\u76f8\u5173\u64cd\u4f5c\u3002 OpenSBI \u7684\u8fd4\u56de\u7ed3\u679c\u4f1a\u5b58\u653e\u5728\u5bc4\u5b58\u5668 a0 \uff0c a1 \u4e2d\uff0c\u5176\u4e2d a0 \u4e3a error code\uff0c a1 \u4e3a\u8fd4\u56de\u503c\uff0c \u6211\u4eec\u7528 sbiret \u6765\u63a5\u53d7\u8fd9\u4e24\u4e2a\u8fd4\u56de\u503c\u3002 \u540c\u5b66\u4eec\u53ef\u4ee5\u53c2\u7167\u5185\u8054\u6c47\u7f16\u7684\u793a\u4f8b\u4e00\u5b8c\u6210\u8be5\u51fd\u6570\u7684\u7f16\u5199\u3002 \u7f16\u5199\u6210\u529f\u540e\uff0c\u8c03\u7528 sbi_ecall(0x1, 0x0, 0x30, 0, 0, 0, 0, 0) \u5c06\u4f1a\u8f93\u51fa\u5b57\u7b26'0'\u3002\u5176\u4e2d 0x1 \u4ee3\u8868 sbi_console_putchar \u7684 ExtensionID\uff0c 0x0 \u4ee3\u8868FunctionID, 0x30\u4ee3\u8868'0'\u7684ascii\u503c\uff0c\u5176\u4f59\u53c2\u6570\u586b0\u3002 \u8bf7\u5728 arch/riscv/kernel/sbi.c \u4e2d\u8865\u5145 sbi_ecall() \u3002 \u4e0b\u9762\u5217\u51fa\u4e86\u4e00\u4e9b\u5728\u540e\u7eed\u7684\u5b9e\u9a8c\u4e2d\u53ef\u80fd\u9700\u8981\u4f7f\u7528\u7684\u529f\u80fd\u3002 Function Name Function ID Extension ID sbi_set_timer \uff08\u8bbe\u7f6e\u65f6\u949f\u76f8\u5173\u5bc4\u5b58\u5668\uff09 0 0x00 sbi_console_putchar \uff08\u6253\u5370\u5b57\u7b26\uff09 0 0x01 sbi_console_getchar \uff08\u63a5\u6536\u5b57\u7b26\uff09 0 0x02 sbi_shutdown \uff08\u5173\u673a\uff09 0 0x08","title":"4.4 \u8865\u5145 sbi.c"},{"location":"lab1/#45-puts-puti","text":"\u8c03\u7528\u4ee5\u4e0a\u5b8c\u6210\u7684 sbi_ecall , \u5b8c\u6210 puts() \u548c puti() \u7684\u5b9e\u73b0\u3002 puts() \u7528\u4e8e\u6253\u5370\u5b57\u7b26\u4e32\uff0c puti() \u7528\u4e8e\u6253\u5370\u6574\u578b\u53d8\u91cf\u3002 \u8bf7\u7f16\u5199 lib/print.c \u4e2d\u7684 puts() \u548c puti() \uff0c \u51fd\u6570\u7684\u76f8\u5173\u5b9a\u4e49\u5df2\u7ecf\u5199\u5728\u4e86 print.h \u6587\u4ef6\u3002","title":"4.5 puts() \u548c puti()"},{"location":"lab1/#46-defs","text":"\u5185\u8054\u6c47\u7f16\u7684\u76f8\u5173\u77e5\u8bc6\u89c1 \u5185\u8054\u6c47\u7f16 \u3002 \u5b66\u4e60\u4e86\u89e3\u4e86\u4ee5\u4e0a\u77e5\u8bc6\u540e\uff0c\u8865\u5145 arch/riscv/include/defs.h \u4e2d\u7684\u4ee3\u7801\u5b8c\u6210\uff1a \u8865\u5145\u5b8c read_csr \u8fd9\u4e2a\u5b8f\u5b9a\u4e49\u3002\u8fd9\u91cc\u6709\u76f8\u5173 \u793a\u4f8b \u3002","title":"4.6 \u4fee\u6539 defs"},{"location":"lab1/#_3","text":"\u8bf7\u603b\u7ed3\u4e00\u4e0b RISC-V \u7684 calling convention\uff0c\u5e76\u89e3\u91ca Caller / Callee Saved Register \u6709\u4ec0\u4e48\u533a\u522b\uff1f \u7f16\u8bd1\u4e4b\u540e\uff0c\u901a\u8fc7 System.map \u67e5\u770b vmlinux.lds \u4e2d\u81ea\u5b9a\u4e49\u7b26\u53f7\u7684\u503c","title":"\u601d\u8003\u9898"},{"location":"lab1/#_4","text":"\u540c\u5b66\u9700\u8981\u63d0\u4ea4\u5b9e\u9a8c\u62a5\u544a\u4ee5\u53ca\u6574\u4e2a\u5de5\u7a0b\u4ee3\u7801\u3002\u5728\u63d0\u4ea4\u524d\u8bf7\u4f7f\u7528 make clean \u6e05\u9664\u6240\u6709\u6784\u5efa\u4ea7\u7269\u3002","title":"\u4f5c\u4e1a\u63d0\u4ea4"}]}